<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VFIED ‚Äì Zero Friction Food Discovery (Live)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;min-height:100vh;overflow-x:hidden}
    .app{max-width:440px;margin:0 auto;min-height:100vh;position:relative;padding:24px 16px 96px}
    .live{position:absolute;top:12px;right:16px;background:#22c55e;color:#fff;padding:6px 12px;border-radius:999px;font-size:12px;font-weight:700;display:flex;gap:8px;align-items:center}
    .dot{width:6px;height:6px;border-radius:999px;background:#fff;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

    .bar{display:flex;gap:8px;flex-wrap:wrap;margin:56px 0 16px}
    .chip{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);padding:6px 12px;border-radius:20px;font-size:13px}

    .card{background:rgba(255,255,255,.15);backdrop-filter:blur(20px);border-radius:24px;padding:24px;border:1px solid rgba(255,255,255,.2);transition:.2s}
    .card.loading{opacity:.6;pointer-events:none}
    .food{font-size:44px;margin-bottom:8px}
    .name{font-size:22px;font-weight:800;margin-bottom:6px}
    .tagline{font-size:14px;opacity:.9;margin-bottom:12px}

    .rest{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);border-radius:14px;padding:14px;margin-top:10px}
    .rest-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .rest-n{font-weight:700}
    .badge{background:#22c55e;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .rest-d{display:flex;gap:12px;font-size:12.5px;opacity:.95;margin-bottom:10px}
    .row{display:flex;gap:10px}
    .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;font-size:14px}
    .primary{background:#22c55e;color:#fff;flex:1}
    .secondary{background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3)}

    .actions{display:flex;gap:10px;margin-top:14px}
    .quick{display:flex;gap:10px;margin:14px 0}
    .qbtn{flex:1;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;padding:12px;border-radius:16px;font-size:13px;font-weight:700;cursor:pointer}

    .nav{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(0,0,0,.75);backdrop-filter:blur(18px);border:1px solid rgba(255,255,255,.12);border-radius:26px;padding:8px;display:flex;gap:6px}
    .nav button{border:none;background:transparent;color:rgba(255,255,255,.7);padding:10px 14px;border-radius:18px;font-weight:700;cursor:pointer}
    .nav .active{background:rgba(255,255,255,.22);color:#fff}

    .panel{margin:16px 0 8px;display:grid;gap:8px}
    .group{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);border-radius:14px;padding:12px}
    .label{font-size:12px;opacity:.9;margin-bottom:6px}
    .row-wrap{display:flex;gap:8px;flex-wrap:wrap}
    .chip-toggle{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.35);background:transparent;color:#fff;font-size:12px;cursor:pointer}
    .chip-toggle.on{background:#22c55e;border-color:#22c55e}
    .input, select{width:100%;padding:10px;border-radius:10px;border:2px solid rgba(255,255,255,.25);background:rgba(255,255,255,.12);color:#fff}
    .side{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .switch{display:flex;align-items:center;gap:8px;font-size:13px;margin-top:6px;opacity:.95}
    .switch input{transform:scale(1.2)}

    .hint{font-size:12px;opacity:.9;margin-top:8px}
    .error{margin-top:10px;background:rgba(255,0,0,.18);border:1px solid rgba(255,0,0,.35);padding:8px;border-radius:10px;font-size:12.5px}
    @media(max-width:380px){.rest-d{flex-direction:column}}
  </style>
</head>
<body>
  <div class="app">
    <div class="live"><span class="dot"></span>LIVE</div>

    <!-- Smart context from API -->
    <div class="bar" id="context-bar">
      <div class="chip">‚è≥ Loading context‚Ä¶</div>
    </div>

    <!-- Controls (dietary, budget, location, source toggle) -->
    <div class="panel">
      <div class="group">
        <div class="label">Dietary</div>
        <div class="row-wrap" id="dietary-chips">
          <!-- toggles are bound in JS -->
        </div>
      </div>

      <div class="group side">
        <div>
          <div class="label">Budget</div>
          <select id="budget">
            <option value="low">¬£ Budget</option>
            <option value="medium" selected>¬£¬£ Medium</option>
            <option value="high">¬£¬£¬£ High</option>
          </select>
        </div>
        <div>
          <div class="label">Use uploaded menu</div>
          <label class="switch"><input type="checkbox" id="use-uploaded"> <span>my_uploaded_menu</span></label>
          <div class="hint">If on, recommendations come from vendor menus you POST to <code>/v1/menus</code>.</div>
        </div>
      </div>

      <div class="group">
        <div class="label">Location</div>
        <div class="row" style="gap:8px">
          <input id="city" class="input" placeholder="City" value="London">
          <input id="country" class="input" placeholder="Country" value="United Kingdom">
          <input id="cc" class="input" placeholder="CC" value="GB" style="max-width:88px">
        </div>
      </div>
    </div>

    <!-- Suggestion card -->
    <div class="card" id="card">
      <div class="food" id="food-emoji">üçΩÔ∏è</div>
      <div class="name" id="food-name">Let me think‚Ä¶</div>
      <div class="tagline" id="tagline">I‚Äôll match weather, culture & your preferences.</div>

      <div class="rest" id="rest">
        <div class="rest-h">
          <div class="rest-n" id="rest-name">Nearby place</div>
          <div class="badge" id="rest-badge">Open</div>
        </div>
        <div class="rest-d" id="rest-details">
          <span>‚≠ê ‚Äî</span><span>üí∑ ‚Äî</span><span>üö∂ ‚Äî</span><span>‚è±Ô∏è ‚Äî</span>
        </div>
        <div class="actions">
          <button class="btn primary" onclick="orderFood()">Order</button>
          <button class="btn secondary" onclick="getDirections()">Directions</button>
        </div>
      </div>

      <div id="dietaryNote" class="hint"></div>
      <div id="weatherNote" class="hint"></div>
      <div id="culturalNote" class="hint"></div>
      <div id="error" class="error" style="display:none"></div>
    </div>

    <!-- Quick actions -->
    <div class="quick">
      <button class="qbtn" onclick="refreshSuggestion()">üéØ Refresh</button>
      <button class="qbtn" onclick="browse()">üîç Browse</button>
      <button class="qbtn" onclick="askFriends()">üë• Ask Friends</button>
    </div>

    <!-- Bottom nav -->
    <div class="nav">
      <button class="active" onclick="nav(this,'instant')">üéØ Instant</button>
      <button onclick="nav(this,'browse')">üîç Browse</button>
      <button onclick="nav(this,'social')">üë• Social</button>
      <button onclick="nav(this,'settings')">‚öôÔ∏è Settings</button>
    </div>
  </div>

  <script>
    // --- CONFIG ---
    const API_BASE = 'http://localhost:3001';
    const AUTH = 'Bearer demo_growth_key_456';

    // --- STATE ---
    const state = {
      dietary: new Set(),          // e.g. 'vegetarian','vegan','halal'
      budget: 'medium',
      useUploaded: false,
      location: { city: 'London', country: 'United Kingdom', country_code: 'GB' },
      last: null
    };

    // --- UI BINDINGS ---
    const chips = ['vegetarian','vegan','gluten-free','dairy-free','keto','halal','kosher','pescatarian'];
    const chipWrap = document.getElementById('dietary-chips');
    chips.forEach(tag => {
      const b = document.createElement('button');
      b.textContent = tag;
      b.className = 'chip-toggle';
      b.onclick = () => { b.classList.toggle('on'); toggleDietary(tag, b.classList.contains('on')); refreshSuggestion(); };
      chipWrap.appendChild(b);
    });

    document.getElementById('budget').addEventListener('change', (e) => {
      state.budget = e.target.value;
      refreshSuggestion();
    });

    document.getElementById('use-uploaded').addEventListener('change', (e) => {
      state.useUploaded = e.target.checked;
      refreshSuggestion();
    });

    ['city','country','cc'].forEach(id => {
      document.getElementById(id).addEventListener('change', syncLocation);
      document.getElementById(id).addEventListener('blur', syncLocation);
    });

    function syncLocation() {
      state.location = {
        city: document.getElementById('city').value || 'London',
        country: document.getElementById('country').value || 'United Kingdom',
        country_code: document.getElementById('cc').value || 'GB'
      };
      refreshSuggestion();
    }

    function toggleDietary(tag, on) {
      if (on) state.dietary.add(tag); else state.dietary.delete(tag);
    }

    // --- HELPERS ---
    function setText(id, val, fallback='') {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = (val ?? '').toString().trim() || fallback;
    }
    function show(id, on) {
      const el = document.getElementById(id);
      if (el) el.style.display = on ? '' : 'none';
    }
    function setContextChips(res) {
      const bar = document.getElementById('context-bar');
      const chips = [];

      // distance is unknown here; use city
      if (state.location.city) chips.push(`üìç ${state.location.city}`);
      if (res?.weather?.isRaining) chips.push('üåßÔ∏è Rainy');
      else if (res?.weather?.isCold) chips.push(`‚ùÑÔ∏è ${Math.round(res.weather.temperature)}¬∞C`);
      else if (res?.weather?.isHot) chips.push(`‚òÄÔ∏è ${Math.round(res.weather.temperature)}¬∞C`);

      const hour = new Date().getHours();
      chips.push(hour>=6&&hour<11?'‚è∞ Breakfast':hour<16?'‚è∞ Lunch':'‚è∞ Dinner');

      bar.innerHTML = chips.map(c => `<div class="chip">${c}</div>`).join('');
    }

    // --- CORE: CALL /v1/recommend ---
    async function refreshSuggestion() {
      const card = document.getElementById('card');
      const err = document.getElementById('error');
      err.style.display = 'none';
      card.classList.add('loading');

      try {
        const body = {
          location: state.location,
          mood_text: 'stressed but want something light', // keep it simple for demo
          dietary: Array.from(state.dietary),
          budget: state.budget,
          menu_source: state.useUploaded ? 'my_uploaded_menu' : 'global_database'
        };

        const res = await fetch(`${API_BASE}/v1/recommend`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': AUTH },
          body: JSON.stringify(body)
        });

        if (!res.ok) throw new Error(`/v1/recommend ${res.status}`);
        const data = await res.json();
        state.last = data;

        // Food
        setText('food-emoji', data.food?.emoji || 'üçΩÔ∏è');
        setText('food-name', data.food?.name || 'Great choice!');
        setText('tagline',
          data.friendMessage || data.reasoning || data.weatherNote || 'Perfect for you.');

        // Restaurant/availability
        const avail = data.availabilityNote || `Good ${data.food?.name || 'food'} nearby`;
        setText('rest-name', avail);
        setText('rest-badge', 'Open');

        // (Fake numbers for now; you can enrich with a real places API later)
        document.getElementById('rest-details').innerHTML =
          `<span>‚≠ê 4.6</span><span>üí∑ ${data.food?.price || '¬£¬£'}</span><span>üö∂ 5 min</span><span>‚è±Ô∏è 5‚Äì10 min</span>`;

        // Notes
        setText('dietaryNote', data.dietaryNote || '');
        setText('weatherNote', data.weatherNote || '');
        setText('culturalNote', data.culturalNote || '');

        setContextChips(data);
      } catch (e) {
        console.error(e);
        err.textContent = 'Could not fetch a live suggestion. Showing a fallback‚Ä¶';
        err.style.display = '';
        // Fallback UI
        setText('food-emoji','üçú');
        setText('food-name','Hot Ramen');
        setText('tagline','Comforting & light for today');
        setText('rest-name','Popular spot nearby');
        document.getElementById('rest-details').innerHTML =
          `<span>‚≠ê 4.5</span><span>üí∑ ¬£¬£</span><span>üö∂ 4 min</span><span>‚è±Ô∏è 10 min</span>`;
        setContextChips(null);
      } finally {
        card.classList.remove('loading');
      }
    }

    // --- Nav/UX stubs ---
    function nav(btn, tab){ document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); /* single-screen demo */ }
    function browse(){ alert('Browse mode coming in Phase 2'); }
    function askFriends(){ alert('Social share coming in Phase 3'); }
    function orderFood(){ alert('Would deep-link to Deliveroo/UberEats here'); }
    function getDirections(){ alert('Would open Apple/Google Maps here'); }

    // --- INIT ---
    (function init(){
      // Pre-select a couple of dietary chips to show state works
      ['vegetarian'].forEach(t=>{
        const btn=[...document.querySelectorAll('.chip-toggle')].find(b=>b.textContent===t);
        if (btn && !btn.classList.contains('on')) { btn.classList.add('on'); state.dietary.add(t); }
      });
      refreshSuggestion();
      // Optional: auto-refresh every 45s like a live tile
      // setInterval(refreshSuggestion, 45000);
    })();
  </script>
</body>
</html>
