<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VFIED ‚Ä¢ Vendor Dashboard</title>
  <style>
    :root { color-scheme: dark; }
    body{margin:0;background:#0f172a;color:#e2e8f0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
    h1{font-size:24px;margin:0 0 8px}
    .muted{opacity:.8}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;gap:12px}
    @media(min-width:920px){.grid-3{grid-template-columns:1fr 1fr 1fr}}
    .card{background:#0b1220;border:1px solid #263247;border-radius:14px;padding:14px}
    label{font-size:13px;opacity:.9}
    input,select,button{background:#0b1220;color:#e2e8f0;border:1px solid #263247;border-radius:10px;padding:8px 10px;outline:none}
    button{background:#6d28d9;border:none;font-weight:700;cursor:pointer}
    button.secondary{background:#334155}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #1f2937;padding:8px 6px;text-align:left;vertical-align:top}
    th{font-weight:700}
    .kpis{display:flex;gap:12px;flex-wrap:wrap}
    .kpi{background:#0b1220;border:1px solid #263247;border-radius:12px;padding:10px 12px;font-size:14px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .pill{display:inline-block;border:1px solid #263247;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:6px}
    .right{margin-left:auto}
    .pill.ok { background:#064e3b; border-color:#10b981; }
    .pill.warn { background:#7c2d12; border-color:#f59e0b; }
    .pill.bad { background:#5b1a1a; border-color:#ef4444; }
    .small { font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <h1>üçΩÔ∏è VFIED ‚Äî Vendor Dashboard</h1>
      <a href="/" class="pill" style="text-decoration:none;color:#e2e8f0">‚Üê Back to App</a>
    </div>
    <div class="muted">Monitor your menu, usage, and recent feedback.</div>

    <div class="card" style="margin-top:12px">
      <div class="row">
        <div>
          <label>API URL</label>
          <input id="baseUrl" value="https://vfied-v3.onrender.com" size="36"/>
        </div>
        <div>
          <label>API Key</label>
          <input id="apiKey" value="demo_growth_key_456" size="28"/>
        </div>
        <button id="refreshBtn" class="right">Refresh</button>
      </div>
    </div>

    <div class="grid grid-3" style="margin-top:12px">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">Summary</h2>
          <button id="loadSummaryBtn" class="secondary">Load</button>
        </div>
        <div id="summaryBox" class="kpis" style="margin-top:8px">
          <div class="kpi">vendor: ‚Äî</div>
          <div class="kpi">items: ‚Äî</div>
          <div class="kpi">version: ‚Äî</div>
          <div class="kpi">updated: ‚Äî</div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">Usage</h2>
          <button id="loadUsageBtn" class="secondary">Load</button>
        </div>
        <div id="usageBox" class="kpis" style="margin-top:8px">
          <div class="kpi">plan: ‚Äî</div>
          <div class="kpi">usage: ‚Äî</div>
          <div class="kpi">limit: ‚Äî</div>
          <div class="kpi">percent: ‚Äî</div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="row" style="gap:8px; align-items:center">
            <h2 style="margin:0">Health</h2>
            <span id="healthPill" class="pill small">‚Äî</span>
          </div>
          <button id="loadHealthBtn" class="secondary">Load</button>
        </div>
        <div id="healthBox" style="margin-top:8px" class="mono small">‚Äî</div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">Menu Items</h2>
        <div class="row">
          <button id="loadMenuBtn" class="secondary">Load</button>
          <button id="exportMenuBtn" class="secondary">Copy JSON</button>
        </div>
      </div>
      <div style="margin-top:8px;overflow:auto">
        <table id="menuTable">
          <thead><tr>
            <th>Name</th><th>Country</th><th>Price</th><th>Availability</th><th>Tags</th><th>ID</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">Recent Feedback</h2>
        <div class="row">
          <select id="telemetryLimit">
            <option>50</option><option selected>100</option><option>200</option><option>500</option>
          </select>
          <button id="loadTelemetryBtn" class="secondary">Load</button>
        </div>
      </div>
      <div id="telemetryBox" class="mono" style="margin-top:8px;white-space:pre-wrap;max-height:300px;overflow:auto">‚Äî</div>
    </div>
  </div>

  <script type="module">
    const $ = (id) => document.getElementById(id);
    const api = () => ({ base: $('baseUrl').value.trim().replace(/\/+$/,''), key: $('apiKey').value.trim() });

    async function jget(path){ const { base, key } = api();
      const r = await fetch(base+path, { headers: { 'Authorization': 'Bearer '+key } }); return await r.json(); }
    async function jpost(path, body){ const { base, key } = api();
      const r = await fetch(base+path, { method:'POST', headers: { 'Content-Type':'application/json','Authorization':'Bearer '+key }, body: JSON.stringify(body||{}) }); return await r.json(); }

    // Summary
    async function loadSummary(){
      const j = await jget('/v1/admin/summary');
      const bx = $('summaryBox'); bx.innerHTML = '';
      const put = (t)=>{ const d=document.createElement('div'); d.className='kpi'; d.textContent=t; bx.appendChild(d); };
      put('vendor: '+(j.vendor_id||'‚Äî')); put('items: '+(j.menu_items ?? '‚Äî'));
      put('version: '+(j.menu_version||'‚Äî')); put('updated: '+(j.updatedAt||'‚Äî'));
    }

    // Usage (from /v1/analytics)
    async function loadUsage(){
      const j = await jget('/v1/analytics');
      const bx = $('usageBox'); bx.innerHTML = '';
      const put = (t)=>{ const d=document.createElement('div'); d.className='kpi'; d.textContent=t; bx.appendChild(d); };
      put('plan: '+(j.plan||'‚Äî'));
      put('usage: '+(j.usage?.current_period ?? '‚Äî'));
      put('limit: '+(j.usage?.limit ?? '‚Äî'));
      put('percent: '+(j.usage?.percentage != null ? j.usage.percentage+'%' : '‚Äî'));
    }

    // Health
    async function loadHealth(){
    const { base } = api();
    const t0 = performance.now();
    let ok = false, j = null;
    try {
        const r = await fetch(base+'/health');
        j = await r.json();
        ok = r.ok && j?.status === 'healthy';
    } catch {
        ok = false;
    }
    const ms = Math.round(performance.now() - t0);

    // Color logic:
    // - RED if request failed or took > 2000ms
    // - YELLOW if healthy but slow (1000‚Äì2000ms) or any core service OFF
    // - GREEN if healthy, <1000ms, and core services OK
    const pill = document.getElementById('healthPill');
    const hb = document.getElementById('healthBox');
    if (!pill || !hb) return;

    const coreOff =
        (j?.services?.gpt === 'off' && String(process.env?.USE_GPT||'').toLowerCase()==='true') ||
        (j?.services?.weather === 'off');

    pill.classList.remove('ok','warn','bad');

    if (!ok || ms > 2000) {
        pill.classList.add('bad');
        pill.textContent = `Unhealthy (${ms}ms)`;
    } else if (ms > 1000 || coreOff) {
        pill.classList.add('warn');
        pill.textContent = `Degraded (${ms}ms)`;
    } else {
        pill.classList.add('ok');
        pill.textContent = `Healthy (${ms}ms)`;
    }

    hb.textContent = JSON.stringify(j || { error: 'unreachable' }, null, 2);
    }

    // Menu
    async function loadMenu(){
      const j = await jget('/v1/menus');
      const tbody = $('menuTable').querySelector('tbody'); tbody.innerHTML='';
      const items = j.items || [];
      items.forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.name||''}</td>
          <td>${it.country_code||''}</td>
          <td>${it.price ?? ''}</td>
          <td>${it.availability||''}</td>
          <td>${Array.isArray(it.tags)? it.tags.join(', ') : ''}</td>
          <td class="mono small">${it.menu_item_id||''}</td>`;
        tbody.appendChild(tr);
      });
    }

    // Export menu (copy to clipboard)
    async function exportMenu(){
      const j = await jget('/v1/menus');
      const text = JSON.stringify(j.items||[], null, 2);
      if (navigator.clipboard?.writeText) { await navigator.clipboard.writeText(text); alert('Menu JSON copied'); }
      else { alert(text); }
    }

    // Telemetry
    async function loadTelemetry(){
      const lim = $('telemetryLimit').value;
      const j = await jget('/v1/admin/telemetry?limit='+encodeURIComponent(lim));
      const lines = (j.items||[]).map(x => JSON.stringify(x)).join('\n');
      $('telemetryBox').textContent = lines || '‚Äî';
    }

    // Buttons
    $('loadSummaryBtn').addEventListener('click', loadSummary);
    $('loadUsageBtn').addEventListener('click', loadUsage);
    $('loadHealthBtn').addEventListener('click', loadHealth);
    $('loadMenuBtn').addEventListener('click', loadMenu);
    $('exportMenuBtn').addEventListener('click', exportMenu);
    $('loadTelemetryBtn').addEventListener('click', loadTelemetry);
    $('refreshBtn').addEventListener('click', ()=>{ loadSummary(); loadUsage(); loadHealth(); loadMenu(); loadTelemetry(); });

    // Auto-load on open
    loadSummary(); loadUsage(); loadHealth(); loadMenu(); loadTelemetry();
  </script>
</body>
</html>
