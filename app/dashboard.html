<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VFIED ‚Ä¢ Vendor Dashboard</title>
  <style>
    :root { color-scheme: dark; }
    body{margin:0;background:#0f172a;color:#e2e8f0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
    h1{font-size:24px;margin:0 0 8px}
    .muted{opacity:.8}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;gap:12px}
    @media(min-width:920px){.grid-3{grid-template-columns:1fr 1fr 1fr}}
    .card{background:#0b1220;border:1px solid #263247;border-radius:14px;padding:14px}
    label{font-size:13px;opacity:.9}
    input,select,button{background:#0b1220;color:#e2e8f0;border:1px solid #263247;border-radius:10px;padding:8px 10px;outline:none}
    button{background:#6d28d9;border:none;font-weight:700;cursor:pointer}
    button.secondary{background:#334155}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #1f2937;padding:8px 6px;text-align:left;vertical-align:top}
    th{font-weight:700}
    .kpis{display:flex;gap:12px;flex-wrap:wrap}
    .kpi{background:#0b1220;border:1px solid #263247;border-radius:12px;padding:10px 12px;font-size:14px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .pill{display:inline-block;border:1px solid #263247;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:6px}
    .pill.ok { background:#064e3b; border-color:#10b981; }
    .pill.warn { background:#7c2d12; border-color:#f59e0b; }
    .pill.bad { background:#5b1a1a; border-color:#ef4444; }
    .small { font-size:12px; }
    .right{margin-left:auto}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #263247;background:#0b1220;font-size:12px}
    .okay{color:#10b981;border-color:#10b981}
    .warn{color:#f59e0b;border-color:#f59e0b}
    .fail{color:#ef4444;border-color:#ef4444}
    ul.chk{list-style:none;padding:0;margin:0}
    ul.chk li{display:flex;gap:8px;align-items:center;padding:6px 0;border-bottom:1px solid #1f2937}
    ul.chk li:last-child{border-bottom:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <h1>üçΩÔ∏è VFIED ‚Äî Vendor Dashboard</h1>
      <a href="/" class="pill" style="text-decoration:none;color:#e2e8f0">‚Üê Back to App</a>
    </div>
    <div class="muted">Monitor your menu, usage, and recent feedback.</div>

    <div class="card" style="margin-top:12px">
      <div class="row">
        <div>
          <label>API URL</label>
          <input id="baseUrl" value="https://vfied-v3.onrender.com" size="36"/>
        </div>
        <div>
          <label>API Key</label>
          <input id="apiKey" value="" size="28"/>
        </div>
        <button id="refreshBtn" class="right">Refresh</button>
      </div>
    </div>

    <div class="grid grid-3" style="margin-top:12px">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">Summary</h2>
          <button id="loadSummaryBtn" class="secondary">Load</button>
        </div>
        <div id="summaryBox" class="kpis" style="margin-top:8px">
          <div class="kpi">vendor: ‚Äî</div>
          <div class="kpi">items: ‚Äî</div>
          <div class="kpi">version: ‚Äî</div>
          <div class="kpi">updated: ‚Äî</div>
        </div>
    </div>

    <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h2 style="margin:0">MVP Checklist</h2>
          <button id="loadChecklistBtn" class="secondary">Load</button>
        </div>
        <div id="checklistBox" style="margin-top:8px">
          <div class="muted">‚Äî</div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">Usage</h2>
          <button id="loadUsageBtn" class="secondary">Load</button>
        </div>
        <div id="usageBox" class="kpis" style="margin-top:8px">
          <div class="kpi">plan: ‚Äî</div>
          <div class="kpi">usage: ‚Äî</div>
          <div class="kpi">limit: ‚Äî</div>
          <div class="kpi">percent: ‚Äî</div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="row" style="gap:8px; align-items:center">
            <h2 style="margin:0">Health</h2>
            <span id="healthPill" class="pill small">‚Äî</span>
          </div>
          <button id="loadHealthBtn" class="secondary">Load</button>
        </div>
        <div id="healthBox" style="margin-top:8px" class="mono small">‚Äî</div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">Menu Items</h2>
        <div class="row">
          <button id="loadMenuBtn" class="secondary">Load</button>
          <button id="exportMenuBtn" class="secondary">Copy JSON</button>
        </div>
      </div>
      <div style="margin-top:8px;overflow:auto">
        <table id="menuTable">
          <thead><tr>
            <th>Name</th><th>Country</th><th>Price</th><th>Availability</th><th>Tags</th><th>ID</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">Recent Feedback</h2>
          <div class="row" style="gap:8px; align-items:center">
            <label class="small">Type</label>
            <select id="telemetryType">
              <option value="">All</option>
              <option value="feedback">Feedback</option>
              <option value="telemetry">Telemetry</option>
            </select>
      
            <label class="small">Since</label>
            <input id="telemetrySince" type="datetime-local" />
      
            <label class="small">Limit</label>
            <select id="telemetryLimit">
              <option>50</option><option selected>100</option><option>200</option><option>500</option>
            </select>
      
            <label class="small">Auto</label>
            <input id="telemetryAuto" type="checkbox" />
      
            <button id="loadTelemetryBtn" class="secondary">Load</button>
          </div>
        </div>
        <div id="telemetryBox" class="mono" style="margin-top:8px;white-space:pre-wrap;max-height:300px;overflow:auto">‚Äî</div>
      </div>
  </div>

  <script type="module">
    const $ = (id) => document.getElementById(id);
    const api = () => ({ base: $('baseUrl').value.trim().replace(/\/+$/,''), key: $('apiKey').value.trim() });
    const CHECK_TIPS = {
        decide_flow:           'Front-end should POST /v1/recommend (or /mcp/get_food_suggestion) and render the result card.',
        countries_api:         'Ensure /v1/countries returns 150+ entries. Keep the ISO fallback in server; verify route not blocked by CORS.',
        dietary_budget_ui:     'Send dietary[] and budget from the UI payload (chips + select) into /v1/recommend.',
        engine_badge:          'Set Engine badge from response: GPT if source=gpt; Vendor Menu if source=uploaded_menu; else Fallback.',
        vendor_menu_upload:    'Upload menu via POST /v1/menus with Bearer key; then GET /v1/menus to verify items exist.',
        share_copy:            'Wire the ‚ÄúShare/Copy‚Äù button to navigator.share() or clipboard; include food name + friend message.',
        feedback_wired:        'POST /v1/feedback from thumbs; confirm it appears in /v1/admin/telemetry (Firestore or file).',
        weather_live:          'Set OPENWEATHER_API_KEY in Render ‚Üí Environment and redeploy. Server already consumes it.',
        gpt_enabled:           'Set USE_GPT=true and OPENAI_API_KEY in Render ‚Üí Environment, then redeploy.',
        events_layer:          'Use mock /v1/events now or set USE_EVENTS_PROVIDER=true and EVENTS_PROVIDER_URL to a proxy.',
        travel_nightplan:      'Use /v1/travel/nightplan; the Travel tab should render timeline + suggest buttons per step.'
        };
    async function jget(path){ const { base, key } = api();
      const r = await fetch(base+path, { headers: { 'Authorization': 'Bearer '+key } }); return await r.json(); }
    async function jpost(path, body){ const { base, key } = api();
      const r = await fetch(base+path, { method:'POST', headers: { 'Content-Type':'application/json','Authorization':'Bearer '+key }, body: JSON.stringify(body||{}) }); return await r.json(); }

    // Summary
    async function loadSummary(){
      const j = await jget('/v1/admin/summary');
      const bx = $('summaryBox'); bx.innerHTML = '';
      const put = (t)=>{ const d=document.createElement('div'); d.className='kpi'; d.textContent=t; bx.appendChild(d); };
      put('vendor: '+(j.vendor_id||'‚Äî')); put('items: '+(j.menu_items ?? '‚Äî'));
      put('version: '+(j.menu_version||'‚Äî')); put('updated: '+(j.updatedAt||'‚Äî'));
    }

    // Usage (from /v1/analytics)
    async function loadUsage(){
      const j = await jget('/v1/analytics');
      const bx = $('usageBox'); bx.innerHTML = '';
      const put = (t)=>{ const d=document.createElement('div'); d.className='kpi'; d.textContent=t; bx.appendChild(d); };
      put('plan: '+(j.plan||'‚Äî'));
      put('usage: '+(j.usage?.current_period ?? '‚Äî'));
      put('limit: '+(j.usage?.limit ?? '‚Äî'));
      put('percent: '+(j.usage?.percentage != null ? j.usage.percentage+'%' : '‚Äî'));
    }

    // Health with pill
    async function loadHealth(){
      const { base } = api();
      const t0 = performance.now();
      let ok = false, j = null;
      try {
        const r = await fetch(base+'/health');
        j = await r.json();
        ok = r.ok && j?.status === 'healthy';
      } catch {
        ok = false;
      }
      const ms = Math.round(performance.now() - t0);

      const pill = document.getElementById('healthPill');
      const hb = document.getElementById('healthBox');
      if (!pill || !hb) return;

      const coreOff =
        (j?.services?.gpt === 'off') ||
        (j?.services?.weather === 'off');

      pill.classList.remove('ok','warn','bad');

      if (!ok || ms > 2000) {
        pill.classList.add('bad');
        pill.textContent = `Unhealthy (${ms}ms)`;
      } else if (ms > 1000 || coreOff) {
        pill.classList.add('warn');
        pill.textContent = `Degraded (${ms}ms)`;
      } else {
        pill.classList.add('ok');
        pill.textContent = `Healthy (${ms}ms)`;
      }

      hb.textContent = JSON.stringify(j || { error: 'unreachable' }, null, 2);
    }

    // Menu
    async function loadMenu(){
      const j = await jget('/v1/menus');
      const tbody = $('menuTable').querySelector('tbody'); tbody.innerHTML='';
      const items = j.items || [];
      items.forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.name||''}</td>
          <td>${it.country_code||''}</td>
          <td>${it.price ?? ''}</td>
          <td>${it.availability||''}</td>
          <td>${Array.isArray(it.tags)? it.tags.join(', ') : ''}</td>
          <td class="mono small">${it.menu_item_id||''}</td>`;
        tbody.appendChild(tr);
      });
    }

    // Export menu (copy to clipboard)
    async function exportMenu(){
      const j = await jget('/v1/menus');
      const text = JSON.stringify(j.items||[], null, 2);
      if (navigator.clipboard?.writeText) { await navigator.clipboard.writeText(text); alert('Menu JSON copied'); }
      else { alert(text); }
    }

    // Telemetry
    async function loadTelemetry(){
    const lim  = document.getElementById('telemetryLimit').value;
    const type = document.getElementById('telemetryType').value;
    const sinceVal = document.getElementById('telemetrySince').value;
    const qs = new URLSearchParams();
    if (lim) qs.set('limit', lim);
    if (type) qs.set('type', type);
    if (sinceVal) {
        const dt = new Date(sinceVal);
        if (!isNaN(dt.getTime())) qs.set('since', dt.toISOString());
    }

    const j = await jget('/v1/admin/telemetry?' + qs.toString());
    const items = j.items || [];
    const lines = items.map(x => JSON.stringify(x)).join('\n');
    document.getElementById('telemetryBox').textContent = lines || '‚Äî';
    }
    // Auto-refresh telemetry
    let telemTimer = null;
    function armTelemetryAuto(){
    clearInterval(telemTimer);
    if (document.getElementById('telemetryAuto').checked) {
        telemTimer = setInterval(loadTelemetry, 10000); // every 10s
    }
    }


    async function loadChecklist(){
    const j = await jget('/v1/admin/checklist');
    const box = document.getElementById('checklistBox');
    if (!box) return;

    const head = `
        <div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
        <span class="badge ${j.summary?.phase1_pass ? 'okay' : 'fail'}">Phase 1 ${j.summary?.phase1_pass ? 'PASS' : 'TODO'}</span>
        <span class="badge ${j.summary?.phase2_seed_pass ? 'okay' : 'warn'}">Phase 2 seed ${j.summary?.phase2_seed_pass ? 'PASS' : 'PARTIAL'}</span>
        <span class="badge">countries: ${j.counts?.countries ?? '‚Äî'}</span>
        <span class="badge">menu items: ${j.counts?.menu_items ?? '‚Äî'}</span>
        </div>`;

        const rows = (j.items || []).map(it => {
        const icon  = it.ok ? '‚úÖ' : '‚õî';
        const color = it.ok ? 'okay' : 'fail';
        const tip   = !it.ok && CHECK_TIPS[it.key] ? `<div class="small muted">Tip: ${CHECK_TIPS[it.key]}</div>` : '';
        return `<li>
                    <span class="badge ${color}">${icon}</span>
                    <div>${it.label}${tip}</div>
                </li>`;
        }).join('');

    box.innerHTML = `${head}<ul class="chk" style="margin-top:10px">${rows}</ul>`;
    }

    document.getElementById('loadChecklistBtn').addEventListener('click', loadChecklist);
    document.getElementById('telemetryAuto').addEventListener('change', armTelemetryAuto);

    // Buttons
    $('loadSummaryBtn').addEventListener('click', loadSummary);
    $('loadUsageBtn').addEventListener('click', loadUsage);
    $('loadHealthBtn').addEventListener('click', loadHealth);
    $('loadMenuBtn').addEventListener('click', loadMenu);
    $('exportMenuBtn').addEventListener('click', exportMenu);
    $('loadTelemetryBtn').addEventListener('click', loadTelemetry);
    $('refreshBtn').addEventListener('click', ()=>{ loadSummary(); loadUsage(); loadHealth(); loadMenu(); loadTelemetry(); });

    // Auto-load on open
    loadSummary(); loadUsage(); loadHealth(); loadMenu(); loadTelemetry(); loadChecklist();
  </script>
  <link rel="stylesheet" href="./src/style.css">
  <script type="module" src="./src/main.js"></script>
  <script>
  // Auto-load stored credentials
  document.addEventListener('DOMContentLoaded', function() {
      const storedKey = localStorage.getItem('vfied_api_key');
      const storedId = localStorage.getItem('vfied_restaurant_id');
      
      if (storedKey) {
          document.getElementById('apiKey').value = storedKey;
      }
      
      // Update base URL to match your local setup
      document.getElementById('baseUrl').value = 'http://localhost:3048';
  });
  </script>
</body>
</html>