<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VFIED ‚Äì One-Tap Shortlists</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0; min-height: 100vh;
      font-family: Inter, system-ui, -apple-system, sans-serif;
      background: linear-gradient(180deg, #0a0e19, #070b14);
      color: #e5ecff; line-height: 1.5;
    }
    #app { max-width: 430px; margin: 0 auto; min-height: 100vh; }
    .glass-card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px; backdrop-filter: blur(20px); margin: 20px; padding: 20px; }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter: blur(8px);
      z-index:1000; opacity:0; transition:opacity .3s ease; }
    .modal.active { display:flex!important; opacity:1; align-items:center; justify-content:center; padding:20px; }
    .modal-content { background:rgba(10,14,25,.95); border:1px solid rgba(255,255,255,.12); border-radius:16px;
      width:100%; max-width:400px; max-height:90vh; overflow:hidden; transform:translateY(20px); transition:transform .3s ease; }
    .modal.active .modal-content { transform:translateY(0); }
    .modal-header { display:flex; justify-content:space-between; align-items:center;
      padding:20px 20px 16px; border-bottom:1px solid rgba(255,255,255,.1); }
    .modal-title { font-size:18px; font-weight:700; margin:0; color:#e5ecff; }
    .modal-close { background:rgba(255,255,255,.1); border:none; border-radius:50%; width:32px; height:32px;
      display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:18px; color:#94a3b8; transition:.2s; }
    .modal-close:hover { background:rgba(255,255,255,.15); color:#e5ecff; }
    .modal-body { padding:20px; max-height:calc(90vh - 80px); overflow-y:auto; }
    .dietary-prefs { background:rgba(255,255,255,0.04); border-radius:12px; padding:16px; margin-bottom:16px; }
    .dietary-prefs h5 { margin:0 0 12px 0; font-size:14px; font-weight:700; display:flex; align-items:center; gap:8px; }
    .diet-chips { display:flex; flex-wrap:wrap; gap:8px; }
    .diet-chip { background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15); border-radius:20px; padding:6px 12px;
      font-size:12px; cursor:pointer; transition:.2s; user-select:none; }
    .diet-chip.active { background: linear-gradient(135deg, #10b981, #059669); border-color:#10b981; color:#fff; }
    .diet-chip:hover:not(.active) { background:rgba(255,255,255,.12); }
    .tab-btn { border:0; padding:12px 16px; font-weight:700; background:transparent; border-radius:12px; cursor:pointer;
      font-size:14px; transition:.2s; color:#94a3b8; }
    .tab-btn.active { color:#fff; background: linear-gradient(135deg, #7c3aed, #6366f1); }
    .tab-btn:hover:not(.active) { color:#cbd5e1; background: rgba(255,255,255,.04); }
    #decide-button { width:100%; padding:20px; border:0; border-radius:16px; font-weight:900; color:#fff; font-size:18px; cursor:pointer;
      background: linear-gradient(135deg, #7c3aed, #6366f1); box-shadow:0 20px 40px rgba(124,58,237,.3); transition:.3s; margin:20px 0; }
    #decide-button:disabled { opacity:.6; cursor:not-allowed; }
    #decide-button:hover:not(:disabled) { transform:translateY(-2px); box-shadow:0 25px 50px rgba(124,58,237,.4); }
    .travel-mode-chip,.event-filter-chip { background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15);
      border-radius:10px; padding:12px; text-align:center; cursor:pointer; font-size:13px; font-weight:600; transition:.2s; }
    .travel-mode-chip:hover,.event-filter-chip:hover { background:rgba(255,255,255,.12); transform:translateY(-1px); }
    .travel-mode-chip.active { background: linear-gradient(135deg, rgba(124,58,237,.2), rgba(99,102,241,.2)); border-color:rgba(124,58,237,.3); color:#a5b4fc; }
    .event-filter-chip.active,.time-filter.active { background:rgba(245,158,11,.2); border-color:rgba(245,158,11,.3); color:#fbbf24; }
    .time-filter { flex:1; padding:8px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15); color:#e5ecff; border-radius:8px;
      font-size:12px; cursor:pointer; font-weight:600; transition:.2s; }
    .time-filter:hover:not(.active) { background:rgba(255,255,255,.12); }
    .travel-action-btn { padding:14px 12px; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.08); color:#e5ecff;
      border-radius:10px; cursor:pointer; font-weight:700; text-align:center; font-size:12px; transition:.2s; }
    .travel-action-btn:hover { background:rgba(255,255,255,.12); transform:translateY(-1px); }
    .event-card { display:flex; align-items:flex-start; gap:12px; padding:14px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08);
      border-radius:10px; margin-bottom:12px; cursor:pointer; transition:.2s; }
    .event-card:hover { background:rgba(255,255,255,.08); transform:translateY(-1px); }
    .event-emoji { font-size:20px; min-width:24px; }
    .event-info { flex:1; }
    .event-title { font-weight:700; font-size:14px; margin-bottom:4px; }
    .event-details { font-size:12px; color:#94a3b8; margin-bottom:4px; }
    .event-description { font-size:11px; color:#64748b; line-height:1.3; }
    .suggestion-result { background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15); border-radius:16px; padding:20px; margin:20px; }
    .hidden { display:none !important; }
    .quick-actions { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin:16px 0; }
    .quick-action { padding:12px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.15); border-radius:12px; text-align:center;
      cursor:pointer; font-size:13px; font-weight:600; transition:.2s; }
    .quick-action:hover { background:rgba(255,255,255,.1); transform:translateY(-1px); }
    .quick-action.primary { background: linear-gradient(135deg, rgba(34,197,94,.2), rgba(16,185,129,.2)); border-color:rgba(34,197,94,.3); }
    @media (max-width: 480px) { #app { max-width:100%; } .glass-card { margin:16px; padding:16px; } .modal { padding:10px; } .modal-content { max-width:100%; } }
    @keyframes loading { 0%{transform:translateX(-100%);} 50%{transform:translateX(200%);} 100%{transform:translateX(-100%);} }
  </style>
</head>
<body>
  <div id="app">
    <header style="text-align:center; padding:20px;">
      <h1 style="font-weight:900; font-size:28px; margin:0 0 8px 0;
                 background: linear-gradient(135deg, #fff, #c7d2fe);
                 -webkit-background-clip: text; background-clip:text; -webkit-text-fill-color:transparent; color:transparent;">
        VFIED üçΩÔ∏è
      </h1>
      <p style="color:#9fb0c9; font-size:13px; margin:0;">One-tap shortlist for food, travel, events</p>
    </header>

    <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,.04); border-radius:8px; padding:8px 12px; margin:20px; font-size:12px;">
      <div style="display:flex; align-items:center; gap:4px; color:#10b981;">üìç <span id="location-display">London, GB</span></div>
      <button id="change-location-btn" style="background:transparent; border:1px solid rgba(255,255,255,.2); border-radius:16px; padding:4px 8px; font-size:10px; cursor:pointer; color:#94a3b8;">
        Change
      </button>
    </div>

    <div class="glass-card">
      <div class="dietary-prefs">
        <h5>ü•ó Quick dietary filters (optional)</h5>
        <div class="diet-chips">
          <div class="diet-chip" data-diet="vegetarian">üå± Vegetarian</div>
          <div class="diet-chip" data-diet="vegan">üåø Vegan</div>
          <div class="diet-chip" data-diet="gluten-free">üåæ No Gluten</div>
          <div class="diet-chip" data-diet="nut-free">üö´ü•ú No Nuts</div>
          <div class="diet-chip" data-diet="dairy-free">ü•õ‚ùå No Dairy</div>
          <div class="diet-chip" data-diet="halal">‚ò™Ô∏è Halal</div>
        </div>
      </div>

      <h3 style="margin:0 0 8px 0; font-size:18px; font-weight:700;">üß† How are you feeling?</h3>
      <div style="background:rgba(255,255,255,.04); padding:8px 12px; border-radius:8px; margin-bottom:16px; font-size:13px; color:#94a3b8;">
        üí° Optional: ‚ÄúStressed but want something healthy‚Äù works better than just ‚Äúhungry‚Äù
      </div>
      <input id="mood-input" placeholder="e.g., celebrating with friends, need comfort food, post-workout hungry..."
             style="width:100%; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15); color:#e5ecff; border-radius:12px; padding:14px 16px; font-size:15px; font-weight:500; margin-bottom:12px;" />
    </div>

    <div style="display:flex; justify-content:center; margin:20px 0;">
      <div style="display:flex; gap:4px; padding:4px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:16px;">
        <button class="tab-btn active" data-tab="food">üçΩÔ∏è Food</button>
        <button class="tab-btn" id="travel-modal-btn">‚úàÔ∏è Travel</button>
        <button class="tab-btn" id="events-modal-btn">üé™ Events</button>
      </div>
    </div>

    <div id="food-tab" class="tab-content">
      <button id="decide-button">
        <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
          <span style="font-size:24px;">üéØ</span>
          <div>
            <div>DECIDE FOR ME</div>
            <div style="font-size:14px; opacity:.9; font-weight:600;">3 picks in seconds</div>
          </div>
        </div>
      </button>
    </div>

    <div id="shortlist-result" class="shortlist-result hidden"></div>

    <div id="suggestion-result" class="suggestion-result hidden">
      <div style="text-align:center; margin:20px 0;">
        <div id="result-emoji" style="font-size:48px; margin-bottom:12px;">üçî</div>
        <h2 id="result-name" style="font-size:24px; font-weight:900; margin:0 0 8px 0;">Your Perfect Match</h2>
      </div>
      <div style="background:rgba(255,255,255,.06); border-radius:12px; padding:12px; margin:16px 0;">
        <h5 style="margin:0 0 8px 0; font-size:14px; font-weight:700; color:#a5b4fc;">ü§î Why this choice?</h5>
        <p id="reasoning-text" style="margin:0; font-size:13px; line-height:1.4; color:#cbd5e1;">Based on your mood and preferences, this hits the perfect balance.</p>
      </div>
      <div class="quick-actions">
        <div class="quick-action primary" id="accept-btn">‚úÖ Perfect!</div>
        <div class="quick-action" id="share-btn">üì§ Share</div>
        <div class="quick-action" id="get-directions-btn">üó∫Ô∏è Directions</div>
        <div class="quick-action" id="try-again-btn">üîÑ Try Again</div>
      </div>
    </div>

    <!-- Travel Modal -->
    <div id="travel-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">üß≥ Your Travel Food Coach</h2>
          <button class="modal-close" id="travel-modal-close">√ó</button>
        </div>
        <div class="modal-body">
          <div style="background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(99,102,241,0.1)); border:1px solid rgba(124,58,237,0.2); border-radius:12px; padding:16px; margin-bottom:20px; text-align:center;">
            <p style="margin:0; font-size:13px; color:#94a3b8;">New to <span style="color:#a5b4fc; font-weight:700;" id="travel-modal-city">London</span>? I‚Äôll map your perfect food journey.</p>
          </div>

          <div style="margin-bottom:20px;">
            <h5 style="margin:0 0 12px 0; font-weight:700;">üéØ What brings you here?</h5>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
              <div class="travel-mode-chip active" data-mode="exploring">üó∫Ô∏è Exploring</div>
              <div class="travel-mode-chip" data-mode="business">üíº Business</div>
              <div class="travel-mode-chip" data-mode="date">üíï Date Night</div>
              <div class="travel-mode-chip" data-mode="family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family</div>
            </div>
          </div>

          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
            <div>
              <label style="font-size:13px; font-weight:600; margin-bottom:6px; display:block;">‚è±Ô∏è How long?</label>
              <select id="travel-duration-modal" style="width:100%; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15); color:#e5ecff; border-radius:10px; padding:10px; font-size:13px;">
                <option value="quick">2-3 hours</option>
                <option value="half-day">Half day</option>
                <option value="full-day" selected>Full day</option>
                <option value="weekend">Weekend</option>
              </select>
            </div>
            <div>
              <label style="font-size:13px; font-weight:600; margin-bottom:6px; display:block;">üí∞ Budget</label>
              <select id="travel-budget-modal" style="width:100%; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15); color:#e5ecff; border-radius:10px; padding:10px; font-size:13px;">
                <option value="budget">Budget ($)</option>
                <option value="medium" selected>Moderate ($$)</option>
                <option value="premium">Premium ($$$)</option>
                <option value="luxury">Luxury ($$$$)</option>
              </select>
            </div>
          </div>

          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
            <button class="travel-action-btn" id="night-plan-modal-btn">üåô Plan My Night</button>
            <button class="travel-action-btn" id="food-crawl-modal-btn">üçΩÔ∏è Food Crawl</button>
            <button class="travel-action-btn" id="city-guide-modal-btn">üó∫Ô∏è City Guide</button>
            <button class="travel-action-btn" id="hidden-gems-modal-btn">üíé Hidden Gems</button>
          </div>

          <div style="background:rgba(255,255,255,.04); border-radius:10px; padding:12px; margin-bottom:16px;">
            <h6 style="margin:0 0 8px 0; font-size:13px; font-weight:700; color:#a5b4fc;">ü§ñ Ask your travel coach</h6>
            <input id="travel-query-modal" placeholder="e.g., best ramen in Tokyo for first-timer" style="width:100%; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15); color:#e5ecff; border-radius:8px; padding:10px; font-size:13px; margin-bottom:8px;" />
            <button id="ask-coach-modal-btn" style="width:100%; padding:10px; background: linear-gradient(135deg, #7c3aed, #6366f1); border:0; border-radius:8px; color:white; font-weight:700; font-size:13px; cursor:pointer;">Ask Coach</button>
          </div>

          <div id="travel-results-modal" class="hidden"></div>
        </div>
      </div>
    </div>

    <!-- Events Modal -->
    <div id="events-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">üé™ Events in <span id="events-modal-city">London</span></h2>
          <button class="modal-close" id="events-modal-close">√ó</button>
        </div>
        <div class="modal-body">
          <div style="background: linear-gradient(135deg, rgba(245,158,11,.1), rgba(251,191,36,.1)); border:1px solid rgba(245,158,11,.2); border-radius:12px; padding:16px; margin-bottom:20px; text-align:center;">
            <p style="margin:0; font-size:13px; color:#94a3b8;">Never miss the good stuff ‚Äî food fests, markets, tastings & more</p>
          </div>

          <div style="margin-bottom:20px;">
            <h5 style="margin:0 0 12px 0; font-weight:700;">üè∑Ô∏è Show me:</h5>
            <div style="display:flex; flex-wrap:wrap; gap:8px;">
              <div class="event-filter-chip active" data-category="all">All Events</div>
              <div class="event-filter-chip" data-category="food">üçΩÔ∏è Food</div>
              <div class="event-filter-chip" data-category="music">üéµ Music</div>
              <div class="event-filter-chip" data-category="market">üè™ Markets</div>
              <div class="event-filter-chip" data-category="culture">üé≠ Culture</div>
              <div class="event-filter-chip" data-category="nightlife">üåÉ Nightlife</div>
            </div>
          </div>

          <div style="margin-bottom:20px;">
            <h5 style="margin:0 0 8px 0; font-weight:700;">üìÖ When:</h5>
            <div style="display:flex; gap:8px;">
              <button class="time-filter active" data-time="today">Today</button>
              <button class="time-filter" data-time="tomorrow">Tomorrow</button>
              <button class="time-filter" data-time="weekend">Weekend</button>
              <button class="time-filter" data-time="this_week">This Week</button>
            </div>
          </div>

          <div id="events-grid-modal">
            <div style="text-align:center; padding:20px; color:#94a3b8;">üé™ Loading events...</div>
          </div>
        </div>
      </div>
    </div>

    <footer style="background: rgba(0,0,0,.2); backdrop-filter: blur(15px); padding:20px; text-align:center; font-size:12px; color:#9fb0c9;">
      <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin-bottom:12px;">
        <div><span style="font-size:18px; font-weight:800; color:#e5ecff; display:block;" id="decisions-count">0</span><span style="font-size:10px; color:#94a3b8;">DECISIONS</span></div>
        <div><span style="font-size:18px; font-weight:800; color:#e5ecff; display:block;">94%</span><span style="font-size:10px; color:#94a3b8;">ACCURACY</span></div>
        <div><span style="font-size:18px; font-weight:800; color:#e5ecff; display:block;">127</span><span style="font-size:10px; color:#94a3b8;">CITIES</span></div>
      </div>
      <div>üåê Connected ‚Ä¢ All systems operational</div>
    </footer>
  </div>

  <script>
    class VFIEDApp {
      constructor() {
        this.API_BASE = location.hostname === 'localhost' ? 'http://localhost:3048' : 'https://vfied-v3.onrender.com';

        this.currentLocation = { city: 'London', country: 'United Kingdom', country_code: 'GB', confidence: 'high' };
        this.selectedDietary = new Set();
        this.currentResult = null;
        this.travelMode = 'exploring';
        this.eventFilters = { category: 'all', time: 'today' };

        this.activeRequests = new Map();
        this.requestTimeouts = new Map();

        this.recentSuggestions = JSON.parse(localStorage.getItem('vfied_recent') || '[]');
        this.userPreferences = JSON.parse(localStorage.getItem('vfied_preferences') || '{}');
        this.trackingData = JSON.parse(localStorage.getItem('vfied_tracking') || '[]');

        const storedCount = parseInt(localStorage.getItem('vfied_decisions') || '0');
        this.init();
        const counterElement = document.getElementById('decisions-count');
        if (counterElement) counterElement.textContent = storedCount;
      }
      CITY_TO_CC = {
        // quick, common cities; extend as needed
        london: 'GB', manchester: 'GB', edinburgh: 'GB',
        paris: 'FR', lyon: 'FR',
        tokyo: 'JP', osaka: 'JP',
        nairobi: 'KE', mombasa: 'KE',
        newyork: 'US', "new york": 'US', losangeles: 'US', "los angeles": 'US', chicago: 'US',
        sydney: 'AU', melbourne: 'AU',
        berlin: 'DE', munich: 'DE',
        madrid: 'ES', barcelona: 'ES',
        rome: 'IT', milan: 'IT'
      };

      guessCountryCode(city) {
        const key = String(city || '').trim().toLowerCase();
        return this.CITY_TO_CC[key] || null;
      }
      // Unified API with AbortController + timeout
      async makeAPIRequest(path, options = {}, key = null, timeoutMs = 30000) {
        const url = `${this.API_BASE}${path}`;
        const controller = new AbortController();
        const id = key || `${path}:${Date.now()}`;

        this.activeRequests.set(id, controller);
        const tmo = setTimeout(() => controller.abort(), timeoutMs);
        this.requestTimeouts.set(id, tmo);

        try {
          const res = await fetch(url, {
            ...options,
            headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
            signal: controller.signal
          });
          return res;
        } finally {
          clearTimeout(this.requestTimeouts.get(id));
          this.requestTimeouts.delete(id);
          this.activeRequests.delete(id);
        }
      }

      init() {
        this.setupEventListeners();
        this.setupDietaryFilters();
        this.updateLocationDisplay();
        this.restoreUserPreferences();
      }

      restoreUserPreferences() {
        if (this.userPreferences.dietary) {
          this.userPreferences.dietary.forEach(d => {
            this.selectedDietary.add(d);
            const chip = document.querySelector(`[data-diet="${d}"]`);
            if (chip) chip.classList.add('active');
          });
        }
        if (this.userPreferences.location) {
          this.currentLocation = this.userPreferences.location;
          this.updateLocationDisplay();
        }
      }

      saveUserPreferences() {
        this.userPreferences = {
          dietary: Array.from(this.selectedDietary),
          location: this.currentLocation,
          lastUsed: Date.now()
        };
        localStorage.setItem('vfied_preferences', JSON.stringify(this.userPreferences));
      }

      setupEventListeners() {
        document.getElementById('travel-modal-btn').addEventListener('click', () => this.openTravelModal());
        document.getElementById('events-modal-btn').addEventListener('click', () => this.openEventsModal());
        document.getElementById('travel-modal-close').addEventListener('click', () => this.closeTravelModal());
        document.getElementById('events-modal-close').addEventListener('click', () => this.closeEventsModal());
        document.getElementById('travel-modal').addEventListener('click', (e) => { if (e.target === e.currentTarget) this.closeTravelModal(); });
        document.getElementById('events-modal').addEventListener('click', (e) => { if (e.target === e.currentTarget) this.closeEventsModal(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { this.closeTravelModal(); this.closeEventsModal(); } });
        document.getElementById('decide-button').addEventListener('click', () => this.makeDecision());

        document.querySelectorAll('.travel-mode-chip').forEach(chip => {
          chip.addEventListener('click', () => {
            document.querySelectorAll('.travel-mode-chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            this.travelMode = chip.dataset.mode;
          });
        });

        document.getElementById('night-plan-modal-btn')?.addEventListener('click', () => this.generateNightPlan());
        document.getElementById('food-crawl-modal-btn')?.addEventListener('click', () => this.generateFoodCrawl());
        document.getElementById('city-guide-modal-btn')?.addEventListener('click', () => this.loadCityGuide());
        document.getElementById('hidden-gems-modal-btn')?.addEventListener('click', () => this.findHiddenGems());
        document.getElementById('ask-coach-modal-btn')?.addEventListener('click', () => this.askTravelCoach());

        document.querySelectorAll('.event-filter-chip').forEach(chip => {
          chip.addEventListener('click', () => {
            document.querySelectorAll('.event-filter-chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            this.eventFilters.category = chip.dataset.category;
            this.loadEvents();
          });
        });
        document.querySelectorAll('.time-filter').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.time-filter').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            this.eventFilters.time = btn.dataset.time;
            this.loadEvents();
          });
        });

        document.getElementById('change-location-btn')?.addEventListener('click', () => this.changeLocation());
        document.getElementById('accept-btn')?.addEventListener('click', () => this.handleAccept());
        document.getElementById('try-again-btn')?.addEventListener('click', () => this.makeDecision());
        document.getElementById('share-btn')?.addEventListener('click', () => this.shareResult());
        document.getElementById('get-directions-btn')?.addEventListener('click', () => this.getDirections());
        document.getElementById('mood-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') this.makeDecision(); });
        document.getElementById('travel-query-modal').addEventListener('keypress', (e) => { if (e.key === 'Enter') this.askTravelCoach(); });
      }

      setupDietaryFilters() {
        document.querySelectorAll('.diet-chip').forEach(chip => {
          chip.addEventListener('click', () => {
            const diet = chip.dataset.diet;
            if (this.selectedDietary.has(diet)) {
              this.selectedDietary.delete(diet);
              chip.classList.remove('active');
            } else {
              this.selectedDietary.add(diet);
              chip.classList.add('active');
            }
            this.saveUserPreferences();
          });
        });
      }

      vibrate(style = 'Medium') {
        if (navigator.vibrate) {
          const duration = style === 'Light' ? 50 : style === 'Heavy' ? 100 : 75;
          navigator.vibrate(duration);
        }
      }

      openTravelModal() {
        const modal = document.getElementById('travel-modal');
        document.getElementById('travel-modal-city').textContent = this.currentLocation.city;
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
      closeTravelModal() { this.cancelAllActiveRequests(); document.getElementById('travel-modal').classList.remove('active'); document.body.style.overflow=''; this.hideTravelResults(); }
      openEventsModal() {
        const modal = document.getElementById('events-modal');
        document.getElementById('events-modal-city').textContent = this.currentLocation.city;
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        this.loadEvents(); // real API
      }
      closeEventsModal() { document.getElementById('events-modal').classList.remove('active'); document.body.style.overflow=''; }

      updateLocationDisplay() {
        const cc = this.currentLocation.country_code || 'GB';
        document.getElementById('location-display').textContent = `${this.currentLocation.city}, ${cc}`;
      }
      changeLocation() {
        const input = prompt('Enter location (e.g., "Tokyo, JP" or just "Tokyo"):');
        if (!input || !input.trim()) return;

        const raw = input.trim();
        let city = raw;
        let cc = null;

        // Accept "City, CC" or "City - CC"
        const m = raw.match(/^(.+?)[,\-]\s*([A-Za-z]{2})$/);
        if (m) {
          city = m[1].trim();
          cc = m[2].trim().toUpperCase();
        } else {
          // Try to guess common cities ‚Üí country code
          cc = this.guessCountryCode(raw) || this.currentLocation.country_code || 'GB';
        }

        this.currentLocation = {
          ...this.currentLocation,
          city,
          country_code: cc
        };

        this.updateLocationDisplay();

        // Also refresh modal headers if open
        const tCity = document.getElementById('travel-modal-city');
        if (tCity) tCity.textContent = city;
        const eCity = document.getElementById('events-modal-city');
        if (eCity) eCity.textContent = city;

        this.saveUserPreferences();
      }

      // Cancel helpers
      cancelAllActiveRequests() {
        for (const [, controller] of this.activeRequests.entries()) controller.abort();
        for (const [, timeoutId] of this.requestTimeouts.entries()) clearTimeout(timeoutId);
        this.activeRequests.clear(); this.requestTimeouts.clear();
      }
      cancelCurrentOperation() { this.cancelAllActiveRequests(); const d=document.getElementById('travel-results-modal'); if (d) { d.innerHTML = `
        <div style="background: rgba(255,255,255,0.06); border-radius:12px; padding:20px; text-align:center;">
          <div style="font-size:24px; margin-bottom:12px;">‚èπÔ∏è</div>
          <div style="color:#94a3b8;">Operation cancelled</div>
          <button onclick="window.vfiedApp.hideTravelResults()" style="background: linear-gradient(135deg, #7c3aed, #6366f1); border:0; border-radius:8px; color:white; padding:8px 16px; font-size:13px; font-weight:600; cursor:pointer; margin-top:12px;">Try Something Else</button>
        </div>`; } }
      hideTravelResults() { const d=document.getElementById('travel-results-modal'); if (d) d.classList.add('hidden'); }

      // Core: one-tap shortlist
      async makeDecision() {
        this.vibrate('Medium');
        this.showLoadingShortlist();
        try {
          const response = await this.makeAPIRequest('/v1/quick_decision', {
            method: 'POST',
            body: JSON.stringify({
              location: {
                city: this.currentLocation.city,
                country: this.currentLocation.country || 'United Kingdom',
                country_code: this.currentLocation.country_code
              },
              dietary: Array.from(this.selectedDietary)
            })
          }, 'quick_decision');
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.decisions) {
              this.showShortlistResult(data.decisions);
              this.vibrate('Light');
            } else throw new Error('No decisions returned');
          } else throw new Error(`HTTP ${response.status}`);
        } catch (e) {
          const offlineShortlist = this.getOfflineShortlist();
          this.showShortlistResult(offlineShortlist);
          this.vibrate('Heavy');
        } finally { this.hideLoadingShortlist(); }
      }

      // Travel Coach
      showTravelCoachLoading() {
        const r = document.getElementById('travel-results-modal');
        r.classList.remove('hidden');
        r.innerHTML = `
          <div style="background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:20px; text-align:center;">
            <div style="font-size:24px; margin-bottom:12px;">ü§î</div>
            <div style="font-weight:700; margin-bottom:8px;">Your coach is thinking...</div>
            <div style="font-size:13px; color:#94a3b8; margin-bottom:16px;">Analyzing local food scene and your preferences</div>
            <div style="width:100%; height:4px; background:rgba(255,255,255,.1); border-radius:2px; margin-bottom:16px; overflow:hidden;">
              <div style="width:30%; height:100%; background: linear-gradient(90deg, #7c3aed, #6366f1); animation: loading 2s ease-in-out infinite;"></div>
            </div>
            <button onclick="window.vfiedApp.cancelCurrentOperation()" style="background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.2); border-radius:8px; padding:6px 12px; color:#94a3b8; font-size:11px; cursor:pointer;">Cancel</button>
          </div>`;
      }
      showTravelCoachCancelled() {
        const d=document.getElementById('travel-results-modal');
        d.innerHTML = `<div style="background:rgba(255,255,255,.06); border-radius:12px; padding:20px; text-align:center;"><div style="font-size:24px; margin-bottom:12px;">‚èπÔ∏è</div><div style="color:#94a3b8; margin-bottom:16px;">Request cancelled</div><button onclick="document.getElementById('travel-query-modal').focus()" style="background: linear-gradient(135deg, #7c3aed, #6366f1); border:0; border-radius:8px; color:white; padding:8px 16px; font-size:13px; font-weight:600; cursor:pointer;">Try Again</button></div>`;
      }
      showTravelActionLoading(msg) {
        const r = document.getElementById('travel-results-modal');
        r.classList.remove('hidden');
        r.innerHTML = `
          <div style="background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:30px; text-align:center;">
            <div style="font-size:32px; margin-bottom:16px;">‚ú®</div>
            <div style="font-weight:700; margin-bottom:12px; font-size:16px;">${this.escapeHtml(msg)}</div>
            <div style="font-size:13px; color:#94a3b8; margin-bottom:20px;">This might take up to 30 seconds...</div>
            <div style="width:100%; height:4px; background:rgba(255,255,255,.1); border-radius:2px; overflow:hidden; margin-bottom:16px;">
              <div style="width:30%; height:100%; background: linear-gradient(90deg, #7c3aed, #6366f1); animation: loading 2s ease-in-out infinite;"></div>
            </div>
            <button onclick="window.vfiedApp.cancelCurrentOperation()" style="background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.2); border-radius:8px; padding:8px 16px; color:#94a3b8; font-size:12px; cursor:pointer;">Cancel Request</button>
          </div>`;
      }
      showTravelActionError(kind) {
        const r=document.getElementById('travel-results-modal');
        r.innerHTML = `<div style="background:rgba(255,255,255,.06); border:1px solid rgba(255,58,58,.2); border-radius:12px; padding:20px; text-align:center;">
          <div style="font-size:24px; margin-bottom:12px;">ü§ï</div>
          <div style="font-weight:700; margin-bottom:8px; color:#fca5a5;">Couldn't load your ${kind}</div>
          <div style="font-size:13px; color:#94a3b8; margin-bottom:16px;">Please check your connection and try again</div>
          <button onclick="window.vfiedApp.hideTravelResults()" style="background: linear-gradient(135deg, #7c3aed, #6366f1); border:0; border-radius:8px; color:white; padding:8px 16px; font-size:13px; font-weight:600; cursor:pointer;">Close</button>
        </div>`;
      }

      async askTravelCoach() {
        const query = document.getElementById('travel-query-modal').value.trim();
        if (!query) { this.showToast('Ask me anything about food in ' + this.currentLocation.city); return; }
        this.showTravelCoachLoading();
        try {
          const response = await this.makeAPIRequest('/v1/travel/coach', {
            method: 'POST',
            body: JSON.stringify({
              query,
              location: this.currentLocation,
              context: {
                mode: this.travelMode,
                budget: document.getElementById('travel-budget-modal')?.value || 'medium',
                duration: document.getElementById('travel-duration-modal')?.value || 'full-day',
                dietary: Array.from(this.selectedDietary)
              }
            })
          }, 'travel_coach');
          const data = await response.json();
          if (data.success) this.showTravelCoachResponse(data); else throw new Error(data.error || 'Failed');
        } catch (e) { if (e.name === 'AbortError') this.showTravelCoachCancelled(); else this.showTravelActionError('coach'); }
      }

      async generateNightPlan() {
        this.showTravelActionLoading('üåô Creating your perfect night...');
        try {
          const modePrompts = {
            exploring: `I want to experience authentic local ${this.currentLocation.city} nightlife and food scene.`,
            business: `One night in ${this.currentLocation.city}. Quality food and sophisticated ambiance.`,
            date: `Romantic evening in ${this.currentLocation.city}. Intimate spots, memorable food.`,
            family: `Family-friendly evening in ${this.currentLocation.city}. Options for all ages.`
          };
          const response = await this.makeAPIRequest('/v1/travel/nightplan', {
            method: 'POST',
            body: JSON.stringify({
              location: this.currentLocation,
              prompt: modePrompts[this.travelMode] || modePrompts.exploring,
              mode: this.travelMode,
              budget: document.getElementById('travel-budget-modal')?.value || 'medium',
              duration: document.getElementById('travel-duration-modal')?.value || 'full-day',
              dietary: Array.from(this.selectedDietary)
            })
          }, 'night_plan');
          const data = await response.json();
          if (data.success) this.showNightPlanResult(data); else throw new Error('Failed');
        } catch (e) { if (e.name !== 'AbortError') this.showTravelActionError('night plan'); }
      }

      async generateFoodCrawl() {
        this.showTravelActionLoading('üçΩÔ∏è Mapping your food adventure...');
        try {
          const duration = document.getElementById('travel-duration-modal')?.value || 'full-day';
          const budget = document.getElementById('travel-budget-modal')?.value || 'medium';
          let crawlType = 'street_food';
          if (this.travelMode === 'business') crawlType = 'restaurant_hop';
          if (this.travelMode === 'date') crawlType = 'cultural_food';
          const crawlDuration = duration === 'quick' ? '2_hours' : duration === 'half-day' ? '3_hours' : duration === 'full-day' ? 'half_day' : '3_hours';

          const response = await this.makeAPIRequest('/v1/travel/food-crawl', {
            method: 'POST',
            body: JSON.stringify({
              location: this.currentLocation,
              crawl_type: crawlType,
              duration: crawlDuration,
              budget,
              dietary: Array.from(this.selectedDietary)
            })
          }, 'food_crawl');
          const data = await response.json();
          if (data.success) this.showFoodCrawlResult(data); else throw new Error('Failed');
        } catch (e) { if (e.name !== 'AbortError') this.showTravelActionError('food crawl'); }
      }

      async loadCityGuide() {
        this.showTravelActionLoading('üó∫Ô∏è Loading insider knowledge...');
        try {
          const response = await this.makeAPIRequest(`/v1/travel/guide/${encodeURIComponent(this.currentLocation.city)}?country_code=${this.currentLocation.country_code}`, {}, 'city_guide');
          const data = await response.json();
          if (data.success) this.showCityGuideResult(data); else throw new Error('Failed');
        } catch (e) { if (e.name !== 'AbortError') this.showTravelActionError('city guide'); }
      }

      async findHiddenGems() {
        this.showTravelActionLoading('üíé Discovering hidden gems...');
        try {
          const hiddenGemsQuery = `What are the best hidden food gems in ${this.currentLocation.city} that only locals know about?`;
          const response = await this.makeAPIRequest('/v1/travel/coach', {
            method: 'POST',
            body: JSON.stringify({
              query: hiddenGemsQuery,
              location: this.currentLocation,
              context: {
                mode: this.travelMode,
                budget: document.getElementById('travel-budget-modal')?.value || 'medium',
                duration: document.getElementById('travel-duration-modal')?.value || 'full-day',
                dietary: Array.from(this.selectedDietary),
                request_type: 'hidden_gems'
              }
            })
          }, 'hidden_gems');
          const data = await response.json();
          if (data.success) this.showHiddenGemsResult(data); else throw new Error('Failed');
        } catch (e) { if (e.name !== 'AbortError') this.showTravelActionError('hidden gems'); }
      }

      // Events
      async loadEvents() {
        const g = document.getElementById('events-grid-modal');
        g.innerHTML = `<div style="text-align:center; padding:20px; color:#94a3b8;">üé™ Loading events...</div>`;
        try {
          const response = await this.makeAPIRequest(
            `/v1/events?city=${encodeURIComponent(this.currentLocation.city)}&country_code=${this.currentLocation.country_code}&category=${this.eventFilters.category}&time=${this.eventFilters.time}`,
            {}, 'events'
          );
          const data = await response.json();
          if (data.success && Array.isArray(data.events)) this.showEventsResults(data.events);
          else throw new Error('No events');
        } catch {
          this.showEventsFallback();
        }
      }
      showEventsResults(events) {
        const g = document.getElementById('events-grid-modal');
        if (!events.length) return this.showEventsFallback();
        g.innerHTML = events.map(ev => `
          <div class="event-card">
            <div class="event-emoji">${ev.tag === 'food' ? 'üç¥' : ev.tag === 'market' ? 'ü•¨' : 'üéâ'}</div>
            <div class="event-info">
              <div class="event-title">${ev.title}</div>
              <div class="event-details">${ev.when || 'Today'} ‚Ä¢ ${ev.location || this.currentLocation.city}</div>
              <div class="event-description">${ev.description || ''}</div>
            </div>
          </div>`).join('');
      }
      showEventsFallback() {
        const g = document.getElementById('events-grid-modal');
        const city = this.currentLocation.city;
        const mock = [
          { title:'Street Food Festival', when:'Tonight 6-11pm', tag:'food', description:'Local vendors showcase signatures', location:city },
          { title:'Borough Market Tour', when:'Sat 10am', tag:'market', description:'Guided tour through iconic market', location:city },
          { title:'Jazz & Wine Evening', when:'Tomorrow 8pm', tag:'music', description:'Smooth jazz + local wine', location:city }
        ];
        this.showEventsResults(mock);
      }

      // Rendering helpers
      showShortlistResult(decisions) {
        const single = document.getElementById('suggestion-result'); if (single) single.classList.add('hidden');
        let section = document.getElementById('shortlist-result');
        if (!section) {
          section = document.createElement('div');
          section.id = 'shortlist-result';
          section.className = 'shortlist-result';
          document.getElementById('decide-button').parentNode.insertBefore(section, document.getElementById('decide-button').nextSibling);
        }
        section.innerHTML = `
          <div style="margin:24px 20px;">
            <h3 style="text-align:center; margin:0 0 20px 0; font-size:18px; font-weight:700; color:#a5b4fc;">Your 3 Perfect Picks</h3>
            <div style="display:grid; gap:12px;">
              ${decisions.map((d,i)=>`
                <div class="decision-card" data-food="${this.escapeHtml(d.name)}" style="background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:16px; cursor:pointer; transition:.2s;"
                     onmouseover="this.style.background='rgba(255,255,255,.1)'" onmouseout="this.style.background='rgba(255,255,255,.06)'">
                  <div style="display:flex; align-items:center; gap:12px;">
                    <div style="font-size:28px;">${d.emoji}</div>
                    <div style="flex:1;">
                      <div style="font-weight:700; font-size:16px; margin-bottom:4px; color:#e5ecff;">${d.name}</div>
                      <div style="font-size:13px; color:#94a3b8; line-height:1.4;">${d.explanation || ''}</div>
                    </div>
                    <div style="background:rgba(16,185,129,.2); border-radius:16px; padding:4px 8px; font-size:11px; font-weight:600; color:#10b981;">#${i+1}</div>
                  </div>
                </div>`).join('')}
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:20px;">
              <button id="shuffle-picks" style="padding:12px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15); border-radius:12px; color:#e5ecff; font-weight:700; cursor:pointer; font-size:14px;">üîÑ New Picks</button>
              <button id="add-mood-context" style="padding:12px; background:rgba(124,58,237,.2); border:1px solid rgba(124,58,237,.3); border-radius:12px; color:#a5b4fc; font-weight:700; cursor:pointer; font-size:14px;">üß† Add Mood</button>
            </div>
          </div>`;
        section.classList.remove('hidden');

        document.getElementById('shuffle-picks').addEventListener('click', () => this.makeDecision());
        document.getElementById('add-mood-context').addEventListener('click', () => this.showAdvancedMode());
        document.querySelectorAll('.decision-card').forEach(card => {
          card.addEventListener('click', () => this.selectFood(card.dataset.food));
        });

        section.scrollIntoView({ behavior:'smooth', block:'center' });
        this.incrementDecisionCount();
      }

      showCityGuideResult(data) {
        const r=document.getElementById('travel-results-modal');
        r.innerHTML = `
          <div style="background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:20px;">
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
              <div style="font-size:24px;">üó∫Ô∏è</div><h4 style="margin:0; color:#a5b4fc; font-size:18px;">${data.city} Food Guide</h4>
            </div>
            <div style="margin-bottom:20px;">
              <h5 style="margin:0 0 12px 0; font-size:14px; font-weight:700; color:#fbbf24;">üçΩÔ∏è Must-Try Dishes</h5>
              <div style="display:grid; gap:8px;">${data.food_scene.signature_dishes.map(d=>`
                <div style="padding:12px; background:rgba(255,255,255,.04); border-radius:8px; border-left:3px solid #fbbf24;">
                  <div style="font-weight:600; font-size:13px;">${d}</div>
                </div>`).join('')}</div>
            </div>
            <div style="margin-bottom:20px;">
              <h5 style="margin:0 0 12px 0; font-size:14px; font-weight:700; color:#10b981;">üèòÔ∏è Best Food Neighborhoods</h5>
              ${data.neighborhoods.map(h=>`
                <div style="padding:12px; background:rgba(255,255,255,.04); border-radius:8px; margin-bottom:8px;">
                  <div style="font-weight:600; font-size:14px; margin-bottom:6px;">${h.name}</div>
                  <div style="font-size:12px; color:#cbd5e1;">${h.vibe}</div>
                  <div style="font-size:11px; color:#10b981; font-weight:600;">Food: ${h.food_specialty}</div>
                </div>`).join('')}
            </div>
            <div>
              <h5 style="margin:0 0 8px 0; font-size:14px; font-weight:700;">üí° Local Tips</h5>
              ${data.local_tips.map(t=>`<div style="padding:10px; background:rgba(34,211,153,.1); border-radius:8px; margin-bottom:8px; font-size:12px;">${t}</div>`).join('')}
            </div>
          </div>`;
      }

      showNightPlanResult(data) {
        const r=document.getElementById('travel-results-modal');
        r.innerHTML = `<div style="background:rgba(255,255,255,.06); border-radius:12px; padding:20px;">
          <h4 style="margin:0 0 16px 0; color:#a5b4fc;">${data.planTitle}</h4>
          ${data.timeline.map(it=>`
            <div style="margin-bottom:16px; padding:14px; background:rgba(255,255,255,.04); border-radius:8px;">
              <div style="font-weight:700; margin-bottom:6px;">${it.time} - ${it.activity}</div>
              <div style="color:#fbbf24; margin-bottom:6px;">${it.emoji} ${it.food}</div>
              <div style="font-size:12px; color:#94a3b8;">${it.note}</div>
              <div style="font-size:11px; color:#10b981; margin-top:4px;">${it.estimated_cost}</div>
            </div>`).join('')}
        </div>`;
      }

      showFoodCrawlResult(data) {
        const r=document.getElementById('travel-results-modal');
        r.innerHTML = `<div style="background:rgba(255,255,255,.06); border-radius:12px; padding:20px;">
          <h4 style="margin:0 0 16px 0; color:#a5b4fc;">${data.crawl_title}</h4>
          ${data.stops.map(s=>`
            <div style="margin-bottom:16px; padding:14px; background:rgba(255,255,255,.04); border-radius:8px;">
              <div style="font-weight:700; margin-bottom:6px;">${s.order}. ${s.time} - ${s.location}</div>
              <div style="color:#fbbf24; margin-bottom:6px;">${s.emoji} ${s.food}</div>
              <div style="font-size:12px; color:#94a3b8; margin-bottom:4px;">${s.reason}</div>
              <div style="font-size:11px; color:#10b981;">üí° ${s.tip}</div>
            </div>`).join('')}
        </div>`;
      }

      showHiddenGemsResult(data) {
        const r=document.getElementById('travel-results-modal');
        r.innerHTML = `<div style="background:rgba(255,255,255,.06); border-radius:12px; padding:20px;">
          <h4 style="margin:0 0 16px 0; color:#a5b4fc;">üíé Hidden Gems in ${this.currentLocation.city}</h4>
          <div style="background:rgba(255,255,255,.04); border-radius:10px; padding:16px; margin-bottom:20px;">
            <p style="margin:0; font-size:14px; color:#e5ecff;">${data.response}</p>
          </div>
          ${(data.recommendations||[]).map(r=>`
            <div style="margin-bottom:12px; padding:12px; background:rgba(255,255,255,.04); border-radius:8px;">
              <div style="font-weight:700; margin-bottom:4px;">${r.name}</div>
              <div style="font-size:12px; color:#94a3b8; margin-bottom:6px;">${r.location}</div>
              <div style="font-size:12px; color:#cbd5e1;">${r.details}</div>
            </div>`).join('')}
        </div>`;
      }

      // Offline fallbacks
      getOfflineShortlist() {
        const by = {
          GB: [
            { name:"Fish & Chips", emoji:"üçü", explanation:"Classic British comfort, always satisfying" },
            { name:"Chicken Curry", emoji:"üçõ", explanation:"UK favourite, warming and familiar" },
            { name:"Full English", emoji:"üç≥", explanation:"Hearty breakfast, proper British fuel" }
          ],
          US: [
            { name:"Classic Burger", emoji:"üçî", explanation:"American staple, filling and reliable" },
            { name:"Caesar Salad", emoji:"ü•ó", explanation:"Fresh greens with satisfying crunch" },
            { name:"BBQ Ribs", emoji:"üçñ", explanation:"Smoky comfort food, weekend worthy" }
          ],
          KE: [
            { name:"Ugali & Sukuma", emoji:"üçΩÔ∏è", explanation:"Traditional comfort, hearty and wholesome" },
            { name:"Nyama Choma", emoji:"ü•©", explanation:"Grilled perfection, social and satisfying" },
            { name:"Chapati & Beans", emoji:"ü´ì", explanation:"Simple comfort, filling and affordable" }
          ],
          JP: [
            { name:"Tonkotsu Ramen", emoji:"üçú", explanation:"Rich broth comfort, perfect for any mood" },
            { name:"Chicken Katsu", emoji:"üç±", explanation:"Crispy satisfaction, simple and delicious" },
            { name:"Sushi Set", emoji:"üç£", explanation:"Clean flavors, light but satisfying" }
          ]
        };
        return by[this.currentLocation.country_code] || by.GB;
      }

      // Misc utilities & actions
      showAdvancedMode() { const m=document.getElementById('mood-input'); if (m) { m.style.display='block'; m.focus(); m.placeholder='Tell me your specific mood for AI-powered picks...'; } this.showToast('Advanced mode: add mood for deeper picks'); }
      selectFood(name) { this.showToast(`Great choice! Enjoy your ${name}`); this.getDirectionsFor(name); }
      getDirections() { if (!this.currentResult) return; const q=encodeURIComponent(`${this.currentResult.name} ${this.currentLocation.city}`); window.open(`https://maps.google.com/maps?q=${q}`,'_blank'); }
      getDirectionsFor(foodName) { const q=encodeURIComponent(`${foodName} near ${this.currentLocation.city}`); window.open(`https://maps.google.com/maps?q=${q}`,'_blank'); }
      handleAccept() { this.showToast('Great choice! Hope you enjoy it!'); }
      async shareResult() {
        if (!this.currentResult) return;
        const text = `VFIED suggested: ${this.currentResult.name}\n\n${this.currentResult.reason || ''}\n\nTry VFIED for one-tap shortlists!`;
        if (navigator.share) { try { await navigator.share({ title:'My VFIED Suggestion', text }); return; } catch {} }
        this.copyToClipboard(text);
      }
      copyToClipboard(text) {
        navigator.clipboard?.writeText(text).then(()=>this.showToast('Copied to clipboard!'))
        .catch(()=>{
          const t=document.createElement('textarea'); t.value=text; document.body.appendChild(t); t.select(); document.execCommand('copy'); t.remove(); this.showToast('Copied to clipboard!');
        });
      }
      incrementDecisionCount() {
        const n = (parseInt(localStorage.getItem('vfied_decisions')||'0')+1); localStorage.setItem('vfied_decisions', String(n));
        const el = document.getElementById('decisions-count'); if (el) el.textContent = n;
      }
      showToast(msg) {
        const d=document.createElement('div');
        d.style.cssText='position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:2000; background:rgba(0,0,0,.9); color:#fff; padding:12px 20px; border-radius:8px; font-size:14px; max-width:300px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,.3);';
        d.textContent=msg; document.body.appendChild(d); setTimeout(()=>d.remove(),3000);
      }
      showLoadingShortlist() {
        const b=document.getElementById('decide-button');
        b.disabled=true;
        b.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; gap:8px;"><div style="font-size:20px;">‚ö°</div><div>Finding your 3 picks...</div></div>`;
      }
      hideLoadingShortlist() {
        const b=document.getElementById('decide-button');
        b.disabled=false;
        b.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; gap:8px;"><span style="font-size:24px;">üéØ</span><div><div>DECIDE FOR ME</div><div style="font-size:14px; opacity:.9; font-weight:600;">3 picks in seconds</div></div></div>`;
      }

      // Coach result renderer
      showTravelCoachResponse(data) {
        const r=document.getElementById('travel-results-modal');
        r.innerHTML = `
          <div style="background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:20px;">
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
              <div style="font-size:20px;">ü§ñ</div>
              <h4 style="margin:0; color:#a5b4fc; font-size:16px;">Your ${this.currentLocation.city} Coach</h4>
            </div>
            <div style="background:rgba(255,255,255,.04); border-radius:10px; padding:16px; margin-bottom:20px;">
              <p style="margin:0; font-size:14px; line-height:1.6; color:#e5ecff;">${data.response}</p>
            </div>
            ${(data.recommendations||[]).length ? `
              <div style="margin-bottom:20px;">
                <h5 style="margin:0 0 12px 0; font-size:14px; font-weight:700; color:#a5b4fc;">üìç Specific Recommendations</h5>
                ${data.recommendations.map(rec=>`
                  <div style="display:flex; gap:12px; margin-bottom:12px; padding:12px; background:rgba(255,255,255,.04); border-radius:8px;">
                    <div style="flex:1;">
                      <div style="font-weight:700; font-size:14px; margin-bottom:4px; color:#e5ecff;">${rec.name}</div>
                      <div style="font-size:13px; color:#94a3b8; margin-bottom:6px;">${rec.location}</div>
                      <div style="font-size:12px; color:#cbd5e1; line-height:1.4;">${rec.details}</div>
                    </div>
                    <div style="background:rgba(255,255,255,.08); border-radius:16px; padding:4px 8px; font-size:11px; font-weight:600; color:#10b981; align-self:flex-start;">
                      ${rec.price_range}
                    </div>
                  </div>`).join('')}
              </div>` : ``}
            ${(data.quick_tips||[]).length ? `
              <div style="margin-bottom:20px;">
                <h5 style="margin:0 0 12px 0; font-size:14px; font-weight:700; color:#a5b4fc;">üí° Pro Tips</h5>
                <div style="display:grid; gap:8px;">${data.quick_tips.map(t=>`
                  <div style="padding:10px 12px; background:rgba(255,255,255,.04); border-radius:8px; font-size:13px; border-left:3px solid #10b981;">${t}</div>`).join('')}
                </div>
              </div>` : ``}
            ${(data.follow_up_questions||[]).length ? `
              <div>
                <h5 style="margin:0 0 12px 0; font-size:14px; font-weight:700; color:#a5b4fc;">‚ùì Ask me more</h5>
                <div style="display:flex; flex-wrap:wrap; gap:8px;">
                  ${data.follow_up_questions.map(q=>`
                    <button onclick="window.askFollowUp('${q.replace(/'/g, "\\'")}')" style="background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15); border-radius:16px; padding:6px 12px; font-size:12px; color:#94a3b8; cursor:pointer;">${q}</button>`).join('')}
                </div>
              </div>` : ``}
          </div>`;
        r.scrollIntoView({ behavior:'smooth', block:'nearest' });
      }

      // Helpers for follow-up
      escapeHtml(t){ const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }
      askFollowUp(question){ document.getElementById('travel-query-modal').value = question; this.askTravelCoach(); }
    }

    // Expose small helper for inline onclick
    window.askFollowUp = (q) => window.vfiedApp?.askFollowUp(q);

    document.addEventListener('DOMContentLoaded', () => { window.vfiedApp = new VFIEDApp(); });
  </script>
</body>
</html>
