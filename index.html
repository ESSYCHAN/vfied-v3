<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2C3E50">
    
    <title>VFIED - What Should I Eat?</title>
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icon-180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/icon-152.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/icon-120.png">
    
    <!-- Android Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/assets/icon-512.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <link rel="stylesheet" href="/src/style.css">
    
    <!-- Additional Styles for Settings -->
    <style>
    /* Quick Settings Styles */
    .quick-settings {
        position: relative;
        margin-bottom: 1rem;
    }

    .settings-btn {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        cursor: pointer;
        backdrop-filter: blur(5px);
        transition: all 0.3s ease;
    }

    .settings-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-1px);
    }

    .settings-panel {
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 15px;
        padding: 1.5rem;
        min-width: 300px;
        max-width: 90vw;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.3);
        z-index: 1000;
        margin-top: 0.5rem;
    }

    .settings-panel.hidden {
        display: none;
    }

    .settings-panel h3 {
        color: #2C3E50;
        margin-bottom: 1rem;
        font-size: 1.2rem;
        text-align: center;
    }

    .setting-group {
        margin-bottom: 1.5rem;
    }

    .setting-group label {
        display: block;
        color: #2C3E50;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .location-select, .dietary-select {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #ddd;
        border-radius: 10px;
        font-size: 1rem;
        background: white;
        color: #2C3E50;
        transition: border-color 0.3s ease;
    }

    .location-select:focus, .dietary-select:focus {
        outline: none;
        border-color: #667eea;
    }

    .dietary-checkboxes {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .dietary-checkboxes label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: normal;
        font-size: 0.9rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 8px;
        transition: background-color 0.2s ease;
    }

    .dietary-checkboxes label:hover {
        background: rgba(102, 126, 234, 0.1);
    }

    .dietary-checkboxes input[type="checkbox"] {
        cursor: pointer;
    }

    .custom-location {
        margin-top: 0.5rem;
        padding: 0.75rem;
        border: 2px solid #ddd;
        border-radius: 10px;
        width: 100%;
        font-size: 1rem;
    }

    .custom-location.hidden {
        display: none;
    }

    .settings-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1.5rem;
    }

    .save-btn, .close-btn {
        flex: 1;
        padding: 0.75rem;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .save-btn {
        background: #667eea;
        color: white;
    }

    .save-btn:hover {
        background: #5a6fd8;
        transform: translateY(-1px);
    }

    .close-btn {
        background: #f8f9fa;
        color: #2C3E50;
        border: 1px solid #ddd;
    }

    .close-btn:hover {
        background: #e9ecef;
    }

    /* Status indicators */
    .current-settings {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        justify-content: center;
    }

    .setting-tag {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    @media (max-width: 480px) {
        .settings-panel {
            min-width: 280px;
            padding: 1rem;
        }
        
        .dietary-checkboxes {
            grid-template-columns: 1fr;
        }

        .settings-actions {
            flex-direction: column;
        }
    }
    </style>
</head>
<body>
    <div id="app">
        <!-- Loading Screen -->
        <div id="loading-screen" class="loading-screen">
            <div class="loading-content">
                <div class="logo">🍽️</div>
                <div class="loading-text">Waking up your food friend...</div>
                <div class="loading-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>

        <!-- Main One-Button App -->
        <div id="main-app" class="main-app hidden">
            <!-- Status Bar Spacer -->
            <div class="status-bar-spacer"></div>
            
            <!-- Simple Header -->
            <header class="simple-header">
                <h1 class="app-title">VFIED</h1>
                <p class="question">What should I eat?</p>
                <div class="context-info" id="context-info">
                    🤖 Analyzing your situation...
                </div>

                <!-- Current Settings Display -->
                <div class="current-settings" id="current-settings">
                    <span class="setting-tag" id="location-tag">📍 Auto-detect</span>
                    <span class="setting-tag hidden" id="dietary-tag">🌱 No restrictions</span>
                </div>

                <!-- Quick Settings -->
                <div class="quick-settings">
                    <button id="settings-btn" class="settings-btn">⚙️ Preferences</button>
                    
                    <div id="settings-panel" class="settings-panel hidden">
                        <h3>🍽️ Food Preferences</h3>
                        
                        <!-- Location Override -->
                        <div class="setting-group">
                            <label>📍 Location:</label>
                            <select id="location-select" class="location-select">
                                <option value="">Auto-detect my location</option>
                                <option value="london,uk">🏰 London, UK</option>
                                <option value="nairobi,ke">🦁 Nairobi, Kenya</option>
                                <option value="tokyo,jp">🗼 Tokyo, Japan</option>
                                <option value="newyork,us">🗽 New York, USA</option>
                                <option value="paris,fr">🗼 Paris, France</option>
                                <option value="mumbai,in">🏙️ Mumbai, India</option>
                                <option value="lagos,ng">🌆 Lagos, Nigeria</option>
                                <option value="sydney,au">🏄 Sydney, Australia</option>
                                <option value="custom">✏️ Custom location...</option>
                            </select>
                            <input id="custom-location" type="text" placeholder="Enter: City, Country" class="custom-location hidden">
                        </div>

                        <!-- Dietary Restrictions -->
                        <div class="setting-group">
                            <label>🌱 Dietary Restrictions:</label>
                            <div class="dietary-checkboxes">
                                <label><input type="checkbox" value="vegetarian"> 🌱 Vegetarian</label>
                                <label><input type="checkbox" value="vegan"> 🥬 Vegan</label>
                                <label><input type="checkbox" value="gluten-free"> 🌾 Gluten-Free</label>
                                <label><input type="checkbox" value="dairy-free"> 🥛 Dairy-Free</label>
                                <label><input type="checkbox" value="keto"> 🥩 Keto</label>
                                <label><input type="checkbox" value="halal"> ☪️ Halal</label>
                                <label><input type="checkbox" value="kosher"> ✡️ Kosher</label>
                                <label><input type="checkbox" value="paleo"> 🦴 Paleo</label>
                            </div>
                        </div>

                        <div class="settings-actions">
                            <button id="save-settings" class="save-btn">💾 Save</button>
                            <button id="close-settings" class="close-btn">❌ Close</button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- The One Button -->
            <main class="one-button-main">
                <div class="decision-area">
                    <button id="decide-button" class="giant-decide-button">
                        <div class="button-icon" id="button-icon">🎯</div>
                        <div class="button-text" id="button-text">DECIDE FOR ME</div>
                        <div class="button-subtitle">I'll figure it out for you</div>
                    </button>
                </div>

                <!-- Quick Suggestion Display -->
                <div id="suggestion-result" class="suggestion-result hidden">
                    <div class="suggestion-card">
                        <div class="food-emoji" id="result-emoji">🍕</div>
                        <div class="food-info">
                            <h2 class="food-name" id="result-name">Pizza Night!</h2>
                            <p class="food-description" id="result-description">
                                Perfect for this tired Tuesday evening
                            </p>
                            <div class="restaurant-info" id="restaurant-info">
                                📍 Tony's Pizza (0.8km, open until 11pm)
                            </div>
                        </div>
                    </div>

                    <div class="decision-actions">
                        <button id="accept-btn" class="action-btn accept">
                            ✅ YES, GET IT!
                        </button>
                        <button id="try-again-btn" class="action-btn try-again">
                            🔄 TRY AGAIN
                        </button>
                    </div>

                    <!-- AI Insights (Collapsible) -->
                    <div class="ai-insights" id="ai-insights">
                        <button class="insights-toggle" id="insights-toggle">
                            🤖 Why this choice? ↓
                        </button>
                        <div class="insights-content hidden" id="insights-content">
                            <div class="cultural-note" id="cultural-note"></div>
                            <div class="personal-note" id="personal-note"></div>
                            <div class="weather-note" id="weather-note"></div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Simple Footer Stats -->
            <footer class="simple-footer">
                <div class="stats-line">
                    <span id="decisions-count">12</span> decisions made • 
                    <span id="time-saved">42</span> minutes saved
                </div>
                <div class="ai-status" id="ai-status">
                    🤖 AI ready with cultural intelligence
                </div>
            </footer>

            <!-- Bottom Safe Area -->
            <div class="bottom-safe-area"></div>
        </div>
    </div>

    <!-- Settings JavaScript -->
    <script>
    console.log('⚙️ SETTINGS SYSTEM LOADING...');

    // Settings state
    let userSettings = {
        location: null, // null = auto-detect
        dietary: [],
        customLocation: null
    };

    // Load settings from localStorage
    function loadSettings() {
        try {
            const saved = localStorage.getItem('vfied_user_settings');
            if (saved) {
                userSettings = { ...userSettings, ...JSON.parse(saved) };
                console.log('📂 Loaded settings:', userSettings);
            }
        } catch (error) {
            console.error('Settings load error:', error);
        }
    }

    // Save settings to localStorage
    function saveSettings() {
        try {
            localStorage.setItem('vfied_user_settings', JSON.stringify(userSettings));
            console.log('💾 Settings saved:', userSettings);
        } catch (error) {
            console.error('Settings save error:', error);
        }
    }

    // Update settings display
    function updateSettingsDisplay() {
        const locationTag = document.getElementById('location-tag');
        const dietaryTag = document.getElementById('dietary-tag');

        // Update location display
        if (userSettings.location) {
            const locationMap = {
                'london,uk': '🏰 London',
                'nairobi,ke': '🦁 Nairobi', 
                'tokyo,jp': '🗼 Tokyo',
                'newyork,us': '🗽 New York',
                'paris,fr': '🗼 Paris',
                'mumbai,in': '🏙️ Mumbai',
                'lagos,ng': '🌆 Lagos',
                'sydney,au': '🏄 Sydney'
            };
            
            locationTag.textContent = locationMap[userSettings.location] || 
                (userSettings.customLocation ? `📍 ${userSettings.customLocation}` : '📍 Custom');
        } else {
            locationTag.textContent = '📍 Auto-detect';
        }

        // Update dietary display
        if (userSettings.dietary.length > 0) {
            const dietaryEmojis = {
                'vegetarian': '🌱',
                'vegan': '🥬', 
                'gluten-free': '🌾',
                'dairy-free': '🥛',
                'keto': '🥩',
                'halal': '☪️',
                'kosher': '✡️',
                'paleo': '🦴'
            };
            
            const icons = userSettings.dietary.map(d => dietaryEmojis[d] || '🍽️').join('');
            dietaryTag.textContent = `${icons} ${userSettings.dietary.length} restriction${userSettings.dietary.length > 1 ? 's' : ''}`;
            dietaryTag.classList.remove('hidden');
        } else {
            dietaryTag.classList.add('hidden');
        }
    }

    // Get current user settings for API calls
    function getCurrentSettings() {
        const settings = {
            dietary: userSettings.dietary
        };

        // Add location if specified
        if (userSettings.location && userSettings.location !== 'custom') {
            const [city, country] = userSettings.location.split(',');
            settings.location = {
                city: city.charAt(0).toUpperCase() + city.slice(1),
                country: country.toUpperCase()
            };
        } else if (userSettings.customLocation) {
            const parts = userSettings.customLocation.split(',').map(s => s.trim());
            if (parts.length >= 2) {
                settings.location = {
                    city: parts[0],
                    country: parts[1]
                };
            }
        }

        return settings;
    }

    // Setup settings panel
    function setupSettingsPanel() {
        const settingsBtn = document.getElementById('settings-btn');
        const settingsPanel = document.getElementById('settings-panel');
        const saveBtn = document.getElementById('save-settings');
        const closeBtn = document.getElementById('close-settings');
        const locationSelect = document.getElementById('location-select');
        const customLocationInput = document.getElementById('custom-location');

        // Toggle settings panel
        settingsBtn.addEventListener('click', () => {
            const isHidden = settingsPanel.classList.contains('hidden');
            if (isHidden) {
                settingsPanel.classList.remove('hidden');
                loadCurrentSettingsIntoPanel();
            } else {
                settingsPanel.classList.add('hidden');
            }
        });

        // Handle custom location input
        locationSelect.addEventListener('change', () => {
            if (locationSelect.value === 'custom') {
                customLocationInput.classList.remove('hidden');
                customLocationInput.focus();
            } else {
                customLocationInput.classList.add('hidden');
            }
        });

        // Save settings
        saveBtn.addEventListener('click', () => {
            saveSettingsFromPanel();
            settingsPanel.classList.add('hidden');
            updateSettingsDisplay();
            
            // Show feedback
            const contextInfo = document.getElementById('context-info');
            if (contextInfo) {
                contextInfo.textContent = '✅ Settings saved! Ready for personalized suggestions.';
            }
        });

        // Close settings
        closeBtn.addEventListener('click', () => {
            settingsPanel.classList.add('hidden');
        });

        // Close when clicking outside
        document.addEventListener('click', (e) => {
            if (!settingsPanel.contains(e.target) && !settingsBtn.contains(e.target)) {
                settingsPanel.classList.add('hidden');
            }
        });
    }

    // Load current settings into panel
    function loadCurrentSettingsIntoPanel() {
        const locationSelect = document.getElementById('location-select');
        const customLocationInput = document.getElementById('custom-location');
        const dietaryCheckboxes = document.querySelectorAll('.dietary-checkboxes input[type="checkbox"]');

        // Load location
        locationSelect.value = userSettings.location || '';
        if (userSettings.location === 'custom' && userSettings.customLocation) {
            customLocationInput.classList.remove('hidden');
            customLocationInput.value = userSettings.customLocation;
        } else {
            customLocationInput.classList.add('hidden');
        }

        // Load dietary restrictions
        dietaryCheckboxes.forEach(checkbox => {
            checkbox.checked = userSettings.dietary.includes(checkbox.value);
        });
    }

    // Save settings from panel
    function saveSettingsFromPanel() {
        const locationSelect = document.getElementById('location-select');
        const customLocationInput = document.getElementById('custom-location');
        const dietaryCheckboxes = document.querySelectorAll('.dietary-checkboxes input[type="checkbox"]');

        // Save location
        userSettings.location = locationSelect.value || null;
        if (locationSelect.value === 'custom') {
            userSettings.customLocation = customLocationInput.value.trim();
        } else {
            userSettings.customLocation = null;
        }

        // Save dietary restrictions
        userSettings.dietary = Array.from(dietaryCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        saveSettings();
        console.log('✅ Settings updated:', userSettings);
    }

    // Initialize settings system
    document.addEventListener('DOMContentLoaded', () => {
        console.log('⚙️ Initializing settings system...');
        loadSettings();
        updateSettingsDisplay();
        setupSettingsPanel();
        
        // Make settings available globally for the main app
        window.vfiedUserSettings = {
            get: getCurrentSettings,
            update: updateSettingsDisplay
        };
        
        console.log('✅ Settings system ready!');
    });
    </script>

    <!-- EMERGENCY BUTTON FIX - THIS WILL MAKE IT WORK -->
    <script>
    console.log('🔧 EMERGENCY BUTTON FIX LOADING...');

    // Force button to work - this runs BEFORE main.js
    function forceButtonFix() {
        const button = document.getElementById('decide-button');
        
        if (!button) {
            console.log('❌ Button not found, retrying in 100ms...');
            setTimeout(forceButtonFix, 100);
            return;
        }
        
        console.log('✅ Button found, forcing it to work...');
        
        // Remove all existing listeners by cloning
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        
        // Force styles to make it clickable
        newButton.style.pointerEvents = 'auto';
        newButton.style.cursor = 'pointer';
        newButton.style.userSelect = 'none';
        newButton.style.zIndex = '1000';
        
        // Add working click handler
        newButton.addEventListener('click', function(e) {
            console.log('🎯 EMERGENCY BUTTON CLICKED!');
            e.preventDefault();
            e.stopPropagation();
            
            // Show immediate visual feedback
            newButton.style.transform = 'scale(0.95)';
            newButton.style.opacity = '0.8';
            
            setTimeout(() => {
                newButton.style.transform = 'scale(1)';
                newButton.style.opacity = '1';
            }, 150);
            
            // Update button text to show it's working
            const buttonText = newButton.querySelector('#button-text');
            const buttonIcon = newButton.querySelector('#button-icon');
            
            if (buttonText) buttonText.textContent = 'THINKING...';
            if (buttonIcon) buttonIcon.textContent = '🤖';
            
            // Try to call main app function if available
            if (window.vfiedApp && window.vfiedApp.handleDecideClick) {
                console.log('🚀 Calling main app handleDecideClick...');
                
                // Get user settings and pass them to the app
                const userPrefs = window.vfiedUserSettings ? window.vfiedUserSettings.get() : {};
                console.log('📋 Using user preferences:', userPrefs);
                
                // Add settings to app context
                if (window.vfiedApp.userPreferences) {
                    window.vfiedApp.userPreferences = userPrefs;
                }
                
                window.vfiedApp.handleDecideClick();
            } else {
                console.log('🎯 Main app not ready, showing fallback suggestion...');
                
                // Show fallback suggestion immediately
                setTimeout(() => {
                    showFallbackSuggestion();
                }, 1500);
            }
        });
        
        // Also add touch event for mobile
        newButton.addEventListener('touchend', function(e) {
            console.log('📱 EMERGENCY TOUCH EVENT!');
            e.preventDefault();
            e.stopPropagation();
            newButton.click();
        });
        
        // Prevent any other events from interfering
        newButton.addEventListener('mousedown', function(e) {
            e.stopPropagation();
        });
        
        newButton.addEventListener('mouseup', function(e) {
            e.stopPropagation();
        });
        
        console.log('✅ EMERGENCY BUTTON IS NOW WORKING!');
    }

    // Fallback suggestion system
    function showFallbackSuggestion() {
        console.log('🍽️ Showing fallback suggestion...');
        
        const foods = [
            { emoji: '🍕', name: 'Pizza Night', desc: 'Classic comfort food that hits the spot' },
            { emoji: '🍔', name: 'Burger Time', desc: 'Satisfying and always a good choice' },
            { emoji: '🍜', name: 'Ramen Bowl', desc: 'Warm, comforting noodles perfect for now' },
            { emoji: '🌮', name: 'Taco Tuesday', desc: 'Fresh, flavorful, and fun to eat' },
            { emoji: '🍣', name: 'Sushi Fresh', desc: 'Light, healthy, and sophisticated' },
            { emoji: '🥗', name: 'Fresh Salad', desc: 'Healthy and refreshing option' },
            { emoji: '🍝', name: 'Pasta Perfect', desc: 'Hearty Italian comfort food' },
            { emoji: '🥙', name: 'Wrap & Go', desc: 'Quick, tasty, and portable' }
        ];
        
        const choice = foods[Math.floor(Math.random() * foods.length)];
        
        // Update the suggestion display
        const suggestionResult = document.getElementById('suggestion-result');
        const resultEmoji = document.getElementById('result-emoji');
        const resultName = document.getElementById('result-name');
        const resultDescription = document.getElementById('result-description');
        const restaurantInfo = document.getElementById('restaurant-info');
        
        if (resultEmoji) resultEmoji.textContent = choice.emoji;
        if (resultName) resultName.textContent = choice.name;
        if (resultDescription) resultDescription.textContent = choice.desc;
        if (restaurantInfo) {
            restaurantInfo.textContent = '📍 Available nearby - check your local options!';
            restaurantInfo.style.display = 'block';
        }
        
        if (suggestionResult) {
            suggestionResult.classList.remove('hidden');
        }
        
        // Reset button
        const button = document.getElementById('decide-button');
        const buttonText = document.getElementById('button-text');
        const buttonIcon = document.getElementById('button-icon');
        
        if (buttonText) buttonText.textContent = 'DECIDE FOR ME';
        if (buttonIcon) buttonIcon.textContent = '🎯';
        
        // Update context
        const contextInfo = document.getElementById('context-info');
        if (contextInfo) {
            contextInfo.textContent = '🎉 Decision made! How does this sound?';
        }
        
        console.log('✅ Fallback suggestion shown:', choice.name);
    }

    // Start the fix when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', forceButtonFix);
    } else {
        forceButtonFix();
    }

    // Backup fix every 3 seconds
    setInterval(() => {
        const btn = document.getElementById('decide-button');
        if (btn) {
            if (btn.style.pointerEvents !== 'auto') {
                console.log('🔧 Re-fixing button pointer events...');
                btn.style.pointerEvents = 'auto';
                btn.style.cursor = 'pointer';
            }
        }
    }, 3000);

    // Hide loading screen after reasonable delay
    setTimeout(() => {
        const loadingScreen = document.getElementById('loading-screen');
        const mainApp = document.getElementById('main-app');
        
        if (loadingScreen && mainApp) {
            console.log('🚀 Showing main app...');
            loadingScreen.style.opacity = '0';
            loadingScreen.style.transition = 'opacity 0.5s ease';
            
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                mainApp.classList.remove('hidden');
                mainApp.style.opacity = '1';
                
                // Force button fix again after app shows
                setTimeout(forceButtonFix, 100);
            }, 500);
        }
    }, 3000);
    </script>

    <!-- LOCATION DETECTION FIX -->
    <script>
    console.log('📍 Setting up location detection...');

    // Force location detection with better error handling
    function forceLocationDetection() {
        console.log('📍 Requesting location permission...');
        
        // Check if geolocation is supported
        if (!navigator.geolocation) {
            console.log('❌ Geolocation not supported by this browser');
            updateLocationStatus('Geolocation not supported');
            return;
        }
        
        // Show user what's happening
        updateLocationStatus('📍 Requesting location permission...');
        
        // Request location with better options
        navigator.geolocation.getCurrentPosition(
            (position) => {
                console.log('✅ Location permission granted!');
                console.log('📍 Location:', position.coords.latitude, position.coords.longitude);
                
                updateLocationStatus(`📍 Location detected: ${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`);
                
                // Try to get city name
                reverseGeocode(position.coords.latitude, position.coords.longitude);
            },
            (error) => {
                console.log('❌ Location permission error:', error);
                
                let errorMessage = '';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = '📍 Location access denied - using general suggestions';
                        showLocationHelp();
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = '📍 Location unavailable - using general suggestions';
                        break;
                    case error.TIMEOUT:
                        errorMessage = '📍 Location request timeout - using general suggestions';
                        break;
                    default:
                        errorMessage = '📍 Location error - using general suggestions';
                        break;
                }
                
                updateLocationStatus(errorMessage);
            },
            {
                enableHighAccuracy: true,
                timeout: 15000, // 15 seconds
                maximumAge: 300000 // 5 minutes cache
            }
        );
    }

    // Reverse geocode to get city name
    async function reverseGeocode(lat, lng) {
        try {
            updateLocationStatus('📍 Getting city name...');
            
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`
            );
            
            if (!response.ok) throw new Error('Geocoding failed');
            
            const data = await response.json();
            const city = data.address?.city || data.address?.town || data.address?.village || 'Unknown City';
            const country = data.address?.country || 'Unknown Country';
            
            console.log('🏙️ City detected:', city, country);
            updateLocationStatus(`📍 ${city}, ${country} - getting local food options!`);
            
            // Update the AI service with better location data
            if (window.aiFoodService) {
                window.aiFoodService.userLocation = {
                    lat, lng, city, country,
                    countryCode: data.address?.country_code?.toUpperCase(),
                    accuracy: 'high',
                    timestamp: new Date().toISOString()
                };
                console.log('✅ AI service location updated');
            }
            
        } catch (error) {
            console.error('Geocoding error:', error);
            updateLocationStatus(`📍 Location detected but city lookup failed`);
        }
    }

    // Update location status in UI
    function updateLocationStatus(message) {
        const contextInfo = document.getElementById('context-info');
        if (contextInfo) {
            contextInfo.textContent = message;
        }
        console.log('📍 Status:', message);
    }

    // Show help for enabling location
    function showLocationHelp() {
        console.log('📍 Showing location help...');
        
        // Create a helpful message
        setTimeout(() => {
            updateLocationStatus('📍 To get local suggestions: click the location icon in your browser address bar');
            
            // Show brief instruction
            setTimeout(() => {
                updateLocationStatus('🤖 Using general food intelligence (enable location for local options)');
            }, 5000);
        }, 2000);
    }

    // Check location permission status
    async function checkLocationPermission() {
        if ('permissions' in navigator) {
            try {
                const permission = await navigator.permissions.query({name: 'geolocation'});
                console.log('📍 Location permission status:', permission.state);
                
                permission.onchange = () => {
                    console.log('📍 Location permission changed to:', permission.state);
                    if (permission.state === 'granted') {
                        forceLocationDetection();
                    }
                };
                
                return permission.state;
            } catch (error) {
                console.log('📍 Cannot check permission status:', error);
                return 'unknown';
            }
        }
        return 'unknown';
    }

    // Auto-request location after app loads
    setTimeout(async () => {
        console.log('📍 Starting location detection...');
        
        const permissionStatus = await checkLocationPermission();
        
        if (permissionStatus === 'granted') {
            console.log('📍 Permission already granted, getting location...');
            forceLocationDetection();
        } else if (permissionStatus === 'prompt' || permissionStatus === 'unknown') {
            console.log('📍 Permission not yet requested, requesting now...');
            forceLocationDetection();
        } else {
            console.log('📍 Permission denied, using fallback');
            updateLocationStatus('📍 Location blocked - using general suggestions (click location icon to enable)');
        }
    }, 3000);
    </script>

    <!-- Main App Script -->
    <script type="module" src="/src/main.js"></script>

    <!-- FIXED ACTION BUTTONS & INSIGHTS TOGGLE -->
    <script>
    // Fix action buttons and insights toggle
    setTimeout(() => {
        console.log('🔧 Setting up action buttons and insights...');
        
        const acceptBtn = document.getElementById('accept-btn');
        const tryAgainBtn = document.getElementById('try-again-btn');
        
        if (acceptBtn) {
            acceptBtn.addEventListener('click', () => {
                console.log('✅ Accept clicked');
                alert('Great choice! Enjoy your meal! 🎉');
                
                // Hide suggestion
                const suggestionResult = document.getElementById('suggestion-result');
                if (suggestionResult) {
                    suggestionResult.classList.add('hidden');
                }
                
                // Update context
                const contextInfo = document.getElementById('context-info');
                if (contextInfo) {
                    contextInfo.textContent = '🎉 Decision made! Time to eat!';
                }
            });
        }
        
        if (tryAgainBtn) {
            tryAgainBtn.addEventListener('click', () => {
                console.log('🔄 Try again clicked');
                
                // Hide current suggestion
                const suggestionResult = document.getElementById('suggestion-result');
                if (suggestionResult) {
                    suggestionResult.classList.add('hidden');
                }
                
                // Trigger new decision
                const button = document.getElementById('decide-button');
                if (button) {
                    button.click();
                }
            });
        }
        
        console.log('✅ Action buttons ready');
    }, 4000);

    // IMPROVED INSIGHTS TOGGLE - SHOWS REAL AI DATA
    setTimeout(() => {
        const insightsToggle = document.getElementById('insights-toggle');
        
        if (insightsToggle) {
            console.log('🤖 Setting up improved insights toggle...');
            
            // Remove old listeners
            const newToggle = insightsToggle.cloneNode(true);
            insightsToggle.parentNode.replaceChild(newToggle, insightsToggle);
            
            newToggle.addEventListener('click', function() {
                console.log('🤖 Insights toggle clicked');
                
                const insightsContent = document.getElementById('insights-content');
                if (!insightsContent) {
                    console.log('❌ Insights content not found');
                    return;
                }
                
                const isHidden = insightsContent.classList.contains('hidden');
                
                if (isHidden) {
                    console.log('📖 Showing insights...');
                    insightsContent.classList.remove('hidden');
                    newToggle.textContent = '🤖 Hide insights ↑';
                    
                    // Get the real insights from the current suggestion
                    const currentSuggestion = window.vfiedApp?.currentSuggestion;
                    
                    const culturalNote = document.getElementById('cultural-note');
                    const personalNote = document.getElementById('personal-note');
                    const weatherNote = document.getElementById('weather-note');
                    
                    if (currentSuggestion) {
                        console.log('📊 Using real suggestion data:', currentSuggestion);
                        
                        // Show real cultural note
                        if (culturalNote && currentSuggestion.culturalNote) {
                            culturalNote.innerHTML = `<strong>🌍 Cultural insight:</strong> ${currentSuggestion.culturalNote}`;
                            culturalNote.style.display = 'block';
                        } else if (culturalNote) {
                            culturalNote.innerHTML = '<strong>🌍 Cultural insight:</strong> This fits well with local dining preferences in your area.';
                            culturalNote.style.display = 'block';
                        }
                        
                        // Show real personal note
                        if (personalNote && currentSuggestion.personalNote) {
                            personalNote.innerHTML = `<strong>🧠 Personal pattern:</strong> ${currentSuggestion.personalNote}`;
                            personalNote.style.display = 'block';
                        } else if (personalNote) {
                            personalNote.innerHTML = '<strong>🧠 Personal pattern:</strong> Based on your previous choices, this matches your preferences.';
                            personalNote.style.display = 'block';
                        }
                        
                        // Show real weather/reasoning note
                        if (weatherNote && currentSuggestion.reason) {
                            weatherNote.innerHTML = `<strong>🎯 Why this works:</strong> ${currentSuggestion.reason}`;
                            weatherNote.style.display = 'block';
                        } else if (weatherNote && currentSuggestion.weatherNote) {
                            weatherNote.innerHTML = `<strong>🌤️ Weather factor:</strong> ${currentSuggestion.weatherNote}`;
                            weatherNote.style.display = 'block';
                        } else if (weatherNote) {
                            weatherNote.innerHTML = '<strong>🎯 Why this works:</strong> Perfect choice for your current mood and situation.';
                            weatherNote.style.display = 'block';
                        }
                    } else {
                        console.log('📋 Using fallback insights');
                        
                        // Show fallback insights with user settings
                        const userPrefs = window.vfiedUserSettings ? window.vfiedUserSettings.get() : {};
                        
                        if (culturalNote) {
                            const locationText = userPrefs.location ? ` in ${userPrefs.location.city}` : '';
                            culturalNote.innerHTML = `<strong>🌍 Cultural insight:</strong> This choice fits perfectly with local dining preferences${locationText}!`;
                            culturalNote.style.display = 'block';
                        }
                        
                        if (personalNote) {
                            const dietaryText = userPrefs.dietary.length > 0 ? ` and meets your ${userPrefs.dietary.join(', ')} requirements` : '';
                            personalNote.innerHTML = `<strong>🧠 Personal pattern:</strong> Based on your preferences${dietaryText}, this is a great match.`;
                            personalNote.style.display = 'block';
                        }
                        
                        if (weatherNote) {
                            weatherNote.innerHTML = '<strong>🎯 Why this works:</strong> Perfect for your current mood and the time of day!';
                            weatherNote.style.display = 'block';
                        }
                    }
                    
                    console.log('✅ Insights displayed successfully');
                } else {
                    console.log('🙈 Hiding insights...');
                    insightsContent.classList.add('hidden');
                    newToggle.textContent = '🤖 Why this choice? ↓';
                }
            });
            
            console.log('✅ Improved insights toggle ready');
        } else {
            console.log('❌ Insights toggle button not found');
        }
    }, 5000);
    </script>
</body>
</html>