<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2C3E50">
    
    <title>VFIED - What Should I Eat?</title>
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icon-180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/icon-152.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/icon-120.png">
    
    <!-- Android Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/assets/icon-512.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <link rel="stylesheet" href="/src/style.css">
</head>
<body>
    <div id="app">
        <!-- Loading Screen -->
        <div id="loading-screen" class="loading-screen">
            <div class="loading-content">
                <div class="logo">üçΩÔ∏è</div>
                <div class="loading-text">Waking up your food friend...</div>
                <div class="loading-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>

        <!-- Main One-Button App -->
        <div id="main-app" class="main-app hidden">
            <!-- Status Bar Spacer -->
            <div class="status-bar-spacer"></div>
            
            <!-- Simple Header -->
            <header class="simple-header">
                <h1 class="app-title">VFIED</h1>
                <p class="question">What should I eat?</p>
                <div class="context-info" id="context-info">
                    ü§ñ Analyzing your situation...
                </div>
            </header>

            <!-- The One Button -->
            <main class="one-button-main">
                <div class="decision-area">
                    <button id="decide-button" class="giant-decide-button">
                        <div class="button-icon" id="button-icon">üéØ</div>
                        <div class="button-text" id="button-text">DECIDE FOR ME</div>
                        <div class="button-subtitle">I'll figure it out for you</div>
                    </button>
                </div>

                <!-- Quick Suggestion Display -->
                <div id="suggestion-result" class="suggestion-result hidden">
                    <div class="suggestion-card">
                        <div class="food-emoji" id="result-emoji">üçï</div>
                        <div class="food-info">
                            <h2 class="food-name" id="result-name">Pizza Night!</h2>
                            <p class="food-description" id="result-description">
                                Perfect for this tired Tuesday evening
                            </p>
                            <div class="restaurant-info" id="restaurant-info">
                                üìç Tony's Pizza (0.8km, open until 11pm)
                            </div>
                        </div>
                    </div>

                    <div class="decision-actions">
                        <button id="accept-btn" class="action-btn accept">
                            ‚úÖ YES, GET IT!
                        </button>
                        <button id="try-again-btn" class="action-btn try-again">
                            üîÑ TRY AGAIN
                        </button>
                    </div>

                    <!-- AI Insights (Collapsible) -->
                    <div class="ai-insights" id="ai-insights">
                        <button class="insights-toggle" id="insights-toggle">
                            ü§ñ Why this choice? ‚Üì
                        </button>
                        <div class="insights-content hidden" id="insights-content">
                            <div class="cultural-note" id="cultural-note"></div>
                            <div class="personal-note" id="personal-note"></div>
                            <div class="weather-note" id="weather-note"></div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Simple Footer Stats -->
            <footer class="simple-footer">
                <div class="stats-line">
                    <span id="decisions-count">12</span> decisions made ‚Ä¢ 
                    <span id="time-saved">42</span> minutes saved
                </div>
                <div class="ai-status" id="ai-status">
                    ü§ñ AI ready with cultural intelligence
                </div>
            </footer>

            <!-- Bottom Safe Area -->
            <div class="bottom-safe-area"></div>
        </div>

        <!-- Settings (Future) - Hidden for now -->
        <div id="settings-panel" class="settings-panel hidden">
            <div class="settings-content">
                <h3>Quick Settings</h3>
                <label class="setting-item">
                    <input type="checkbox" id="include-restaurants"> 
                    Show restaurant suggestions
                </label>
                <label class="setting-item">
                    <input type="checkbox" id="cultural-priority" checked> 
                    Prioritize local foods
                </label>
                <button id="close-settings" class="close-settings">Done</button>
            </div>
        </div>
    </div>

    <!-- EMERGENCY BUTTON FIX - THIS WILL MAKE IT WORK -->
    <script>
    console.log('üîß EMERGENCY BUTTON FIX LOADING...');

    // Force button to work - this runs BEFORE main.js
    function forceButtonFix() {
        const button = document.getElementById('decide-button');
        
        if (!button) {
            console.log('‚ùå Button not found, retrying in 100ms...');
            setTimeout(forceButtonFix, 100);
            return;
        }
        
        console.log('‚úÖ Button found, forcing it to work...');
        
        // Remove all existing listeners by cloning
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        
        // Force styles to make it clickable
        newButton.style.pointerEvents = 'auto';
        newButton.style.cursor = 'pointer';
        newButton.style.userSelect = 'none';
        newButton.style.zIndex = '1000';
        
        // Add working click handler
        newButton.addEventListener('click', function(e) {
            console.log('üéØ EMERGENCY BUTTON CLICKED!');
            e.preventDefault();
            e.stopPropagation();
            
            // Show immediate visual feedback
            newButton.style.transform = 'scale(0.95)';
            newButton.style.opacity = '0.8';
            
            setTimeout(() => {
                newButton.style.transform = 'scale(1)';
                newButton.style.opacity = '1';
            }, 150);
            
            // Update button text to show it's working
            const buttonText = newButton.querySelector('#button-text');
            const buttonIcon = newButton.querySelector('#button-icon');
            
            if (buttonText) buttonText.textContent = 'THINKING...';
            if (buttonIcon) buttonIcon.textContent = 'ü§ñ';
            
            // Try to call main app function if available
            if (window.vfiedApp && window.vfiedApp.handleDecideClick) {
                console.log('üöÄ Calling main app handleDecideClick...');
                window.vfiedApp.handleDecideClick();
            } else {
                console.log('üéØ Main app not ready, showing fallback suggestion...');
                
                // Show fallback suggestion immediately
                setTimeout(() => {
                    showFallbackSuggestion();
                }, 1500);
            }
        });
        
        // Also add touch event for mobile
        newButton.addEventListener('touchend', function(e) {
            console.log('üì± EMERGENCY TOUCH EVENT!');
            e.preventDefault();
            e.stopPropagation();
            newButton.click();
        });
        
        // Prevent any other events from interfering
        newButton.addEventListener('mousedown', function(e) {
            e.stopPropagation();
        });
        
        newButton.addEventListener('mouseup', function(e) {
            e.stopPropagation();
        });
        
        console.log('‚úÖ EMERGENCY BUTTON IS NOW WORKING!');
    }

    // Fallback suggestion system
    function showFallbackSuggestion() {
        console.log('üçΩÔ∏è Showing fallback suggestion...');
        
        const foods = [
            { emoji: 'üçï', name: 'Pizza Night', desc: 'Classic comfort food that hits the spot' },
            { emoji: 'üçî', name: 'Burger Time', desc: 'Satisfying and always a good choice' },
            { emoji: 'üçú', name: 'Ramen Bowl', desc: 'Warm, comforting noodles perfect for now' },
            { emoji: 'üåÆ', name: 'Taco Tuesday', desc: 'Fresh, flavorful, and fun to eat' },
            { emoji: 'üç£', name: 'Sushi Fresh', desc: 'Light, healthy, and sophisticated' },
            { emoji: 'ü•ó', name: 'Fresh Salad', desc: 'Healthy and refreshing option' },
            { emoji: 'üçù', name: 'Pasta Perfect', desc: 'Hearty Italian comfort food' },
            { emoji: 'ü•ô', name: 'Wrap & Go', desc: 'Quick, tasty, and portable' }
        ];
        
        const choice = foods[Math.floor(Math.random() * foods.length)];
        
        // Update the suggestion display
        const suggestionResult = document.getElementById('suggestion-result');
        const resultEmoji = document.getElementById('result-emoji');
        const resultName = document.getElementById('result-name');
        const resultDescription = document.getElementById('result-description');
        const restaurantInfo = document.getElementById('restaurant-info');
        
        if (resultEmoji) resultEmoji.textContent = choice.emoji;
        if (resultName) resultName.textContent = choice.name;
        if (resultDescription) resultDescription.textContent = choice.desc;
        if (restaurantInfo) {
            restaurantInfo.textContent = 'üìç Available nearby - check your local options!';
            restaurantInfo.style.display = 'block';
        }
        
        if (suggestionResult) {
            suggestionResult.classList.remove('hidden');
        }
        
        // Reset button
        const button = document.getElementById('decide-button');
        const buttonText = document.getElementById('button-text');
        const buttonIcon = document.getElementById('button-icon');
        
        if (buttonText) buttonText.textContent = 'DECIDE FOR ME';
        if (buttonIcon) buttonIcon.textContent = 'üéØ';
        
        // Update context
        const contextInfo = document.getElementById('context-info');
        if (contextInfo) {
            contextInfo.textContent = 'üéâ Decision made! How does this sound?';
        }
        
        console.log('‚úÖ Fallback suggestion shown:', choice.name);
    }

    // Start the fix when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', forceButtonFix);
    } else {
        forceButtonFix();
    }

    // Backup fix every 3 seconds
    setInterval(() => {
        const btn = document.getElementById('decide-button');
        if (btn) {
            if (btn.style.pointerEvents !== 'auto') {
                console.log('üîß Re-fixing button pointer events...');
                btn.style.pointerEvents = 'auto';
                btn.style.cursor = 'pointer';
            }
        }
    }, 3000);

    // Hide loading screen after reasonable delay
    setTimeout(() => {
        const loadingScreen = document.getElementById('loading-screen');
        const mainApp = document.getElementById('main-app');
        
        if (loadingScreen && mainApp) {
            console.log('üöÄ Showing main app...');
            loadingScreen.style.opacity = '0';
            loadingScreen.style.transition = 'opacity 0.5s ease';
            
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                mainApp.classList.remove('hidden');
                mainApp.style.opacity = '1';
                
                // Force button fix again after app shows
                setTimeout(forceButtonFix, 100);
            }, 500);
        }
    }, 3000);
    </script>

    <!-- LOCATION DETECTION FIX -->
    <script>
    console.log('üìç Setting up location detection...');

    // Force location detection with better error handling
    function forceLocationDetection() {
        console.log('üìç Requesting location permission...');
        
        // Check if geolocation is supported
        if (!navigator.geolocation) {
            console.log('‚ùå Geolocation not supported by this browser');
            updateLocationStatus('Geolocation not supported');
            return;
        }
        
        // Show user what's happening
        updateLocationStatus('üìç Requesting location permission...');
        
        // Request location with better options
        navigator.geolocation.getCurrentPosition(
            (position) => {
                console.log('‚úÖ Location permission granted!');
                console.log('üìç Location:', position.coords.latitude, position.coords.longitude);
                
                updateLocationStatus(`üìç Location detected: ${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`);
                
                // Try to get city name
                reverseGeocode(position.coords.latitude, position.coords.longitude);
            },
            (error) => {
                console.log('‚ùå Location permission error:', error);
                
                let errorMessage = '';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'üìç Location access denied - using general suggestions';
                        showLocationHelp();
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'üìç Location unavailable - using general suggestions';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'üìç Location request timeout - using general suggestions';
                        break;
                    default:
                        errorMessage = 'üìç Location error - using general suggestions';
                        break;
                }
                
                updateLocationStatus(errorMessage);
            },
            {
                enableHighAccuracy: true,
                timeout: 15000, // 15 seconds
                maximumAge: 300000 // 5 minutes cache
            }
        );
    }

    // Reverse geocode to get city name
    async function reverseGeocode(lat, lng) {
        try {
            updateLocationStatus('üìç Getting city name...');
            
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`
            );
            
            if (!response.ok) throw new Error('Geocoding failed');
            
            const data = await response.json();
            const city = data.address?.city || data.address?.town || data.address?.village || 'Unknown City';
            const country = data.address?.country || 'Unknown Country';
            
            console.log('üèôÔ∏è City detected:', city, country);
            updateLocationStatus(`üìç ${city}, ${country} - getting local food options!`);
            
            // Update the AI service with better location data
            if (window.aiFoodService) {
                window.aiFoodService.userLocation = {
                    lat, lng, city, country,
                    countryCode: data.address?.country_code?.toUpperCase(),
                    accuracy: 'high',
                    timestamp: new Date().toISOString()
                };
                console.log('‚úÖ AI service location updated');
            }
            
        } catch (error) {
            console.error('Geocoding error:', error);
            updateLocationStatus(`üìç Location detected but city lookup failed`);
        }
    }

    // Update location status in UI
    function updateLocationStatus(message) {
        const contextInfo = document.getElementById('context-info');
        if (contextInfo) {
            contextInfo.textContent = message;
        }
        console.log('üìç Status:', message);
    }

    // Show help for enabling location
    function showLocationHelp() {
        console.log('üìç Showing location help...');
        
        // Create a helpful message
        setTimeout(() => {
            updateLocationStatus('üìç To get local suggestions: click the location icon in your browser address bar');
            
            // Show brief instruction
            setTimeout(() => {
                updateLocationStatus('ü§ñ Using general food intelligence (enable location for local options)');
            }, 5000);
        }, 2000);
    }

    // Check location permission status
    async function checkLocationPermission() {
        if ('permissions' in navigator) {
            try {
                const permission = await navigator.permissions.query({name: 'geolocation'});
                console.log('üìç Location permission status:', permission.state);
                
                permission.onchange = () => {
                    console.log('üìç Location permission changed to:', permission.state);
                    if (permission.state === 'granted') {
                        forceLocationDetection();
                    }
                };
                
                return permission.state;
            } catch (error) {
                console.log('üìç Cannot check permission status:', error);
                return 'unknown';
            }
        }
        return 'unknown';
    }

    // Auto-request location after app loads
    setTimeout(async () => {
        console.log('üìç Starting location detection...');
        
        const permissionStatus = await checkLocationPermission();
        
        if (permissionStatus === 'granted') {
            console.log('üìç Permission already granted, getting location...');
            forceLocationDetection();
        } else if (permissionStatus === 'prompt' || permissionStatus === 'unknown') {
            console.log('üìç Permission not yet requested, requesting now...');
            forceLocationDetection();
        } else {
            console.log('üìç Permission denied, using fallback');
            updateLocationStatus('üìç Location blocked - using general suggestions (click location icon to enable)');
        }
    }, 3000);

    // Add a manual location button for troubleshooting
    function addLocationButton() {
        // Only add if not already present
        if (document.getElementById('manual-location-btn')) return;
        
        const header = document.querySelector('.simple-header');
        if (header) {
            const locationBtn = document.createElement('button');
            locationBtn.id = 'manual-location-btn';
            locationBtn.textContent = 'üìç Enable Location';
            locationBtn.style.cssText = `
                background: rgba(255,255,255,0.2);
                border: 1px solid rgba(255,255,255,0.3);
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 20px;
                font-size: 0.8rem;
                cursor: pointer;
                margin-top: 0.5rem;
                backdrop-filter: blur(5px);
            `;
            
            locationBtn.addEventListener('click', () => {
                console.log('üìç Manual location request triggered');
                forceLocationDetection();
            });
            
            header.appendChild(locationBtn);
            console.log('üìç Manual location button added');
        }
    }

    // Add the manual button after a delay
    setTimeout(addLocationButton, 6000);
    </script>

    <!-- Main App Script -->
    <script type="module" src="/src/main.js"></script>

    <!-- FIXED ACTION BUTTONS & INSIGHTS TOGGLE -->
    <script>
    // Fix action buttons and insights toggle
    setTimeout(() => {
        console.log('üîß Setting up action buttons and insights...');
        
        const acceptBtn = document.getElementById('accept-btn');
        const tryAgainBtn = document.getElementById('try-again-btn');
        
        if (acceptBtn) {
            acceptBtn.addEventListener('click', () => {
                console.log('‚úÖ Accept clicked');
                alert('Great choice! Enjoy your meal! üéâ');
                
                // Hide suggestion
                const suggestionResult = document.getElementById('suggestion-result');
                if (suggestionResult) {
                    suggestionResult.classList.add('hidden');
                }
                
                // Update context
                const contextInfo = document.getElementById('context-info');
                if (contextInfo) {
                    contextInfo.textContent = 'üéâ Decision made! Time to eat!';
                }
            });
        }
        
        if (tryAgainBtn) {
            tryAgainBtn.addEventListener('click', () => {
                console.log('üîÑ Try again clicked');
                
                // Hide current suggestion
                const suggestionResult = document.getElementById('suggestion-result');
                if (suggestionResult) {
                    suggestionResult.classList.add('hidden');
                }
                
                // Trigger new decision
                const button = document.getElementById('decide-button');
                if (button) {
                    button.click();
                }
            });
        }
        
        console.log('‚úÖ Action buttons ready');
    }, 4000);

    // IMPROVED INSIGHTS TOGGLE - SHOWS REAL AI DATA
    setTimeout(() => {
        const insightsToggle = document.getElementById('insights-toggle');
        
        if (insightsToggle) {
            console.log('ü§ñ Setting up improved insights toggle...');
            
            // Remove old listeners
            const newToggle = insightsToggle.cloneNode(true);
            insightsToggle.parentNode.replaceChild(newToggle, insightsToggle);
            
            newToggle.addEventListener('click', function() {
                console.log('ü§ñ Insights toggle clicked');
                
                const insightsContent = document.getElementById('insights-content');
                if (!insightsContent) {
                    console.log('‚ùå Insights content not found');
                    return;
                }
                
                const isHidden = insightsContent.classList.contains('hidden');
                
                if (isHidden) {
                    console.log('üìñ Showing insights...');
                    insightsContent.classList.remove('hidden');
                    newToggle.textContent = 'ü§ñ Hide insights ‚Üë';
                    
                    // Get the real insights from the current suggestion
                    const currentSuggestion = window.vfiedApp?.currentSuggestion;
                    
                    const culturalNote = document.getElementById('cultural-note');
                    const personalNote = document.getElementById('personal-note');
                    const weatherNote = document.getElementById('weather-note');
                    
                    if (currentSuggestion) {
                        console.log('üìä Using real suggestion data:', currentSuggestion);
                        
                        // Show real cultural note
                        if (culturalNote && currentSuggestion.culturalNote) {
                            culturalNote.innerHTML = `<strong>üåç Cultural insight:</strong> ${currentSuggestion.culturalNote}`;
                            culturalNote.style.display = 'block';
                        } else if (culturalNote) {
                            culturalNote.innerHTML = '<strong>üåç Cultural insight:</strong> This fits well with local dining preferences in your area.';
                            culturalNote.style.display = 'block';
                        }
                        
                        // Show real personal note
                        if (personalNote && currentSuggestion.personalNote) {
                            personalNote.innerHTML = `<strong>üß† Personal pattern:</strong> ${currentSuggestion.personalNote}`;
                            personalNote.style.display = 'block';
                        } else if (personalNote) {
                            personalNote.innerHTML = '<strong>üß† Personal pattern:</strong> Based on your previous choices, this matches your preferences.';
                            personalNote.style.display = 'block';
                        }
                        
                        // Show real weather/reasoning note
                        if (weatherNote && currentSuggestion.reason) {
                            weatherNote.innerHTML = `<strong>üéØ Why this works:</strong> ${currentSuggestion.reason}`;
                            weatherNote.style.display = 'block';
                        } else if (weatherNote && currentSuggestion.weatherNote) {
                            weatherNote.innerHTML = `<strong>üå§Ô∏è Weather factor:</strong> ${currentSuggestion.weatherNote}`;
                            weatherNote.style.display = 'block';
                        } else if (weatherNote) {
                            weatherNote.innerHTML = '<strong>üéØ Why this works:</strong> Perfect choice for your current mood and situation.';
                            weatherNote.style.display = 'block';
                        }
                    } else {
                        console.log('üìã Using fallback insights');
                        
                        // Show fallback insights
                        if (culturalNote) {
                            culturalNote.innerHTML = '<strong>üåç Cultural insight:</strong> This choice fits perfectly with local dining preferences!';
                            culturalNote.style.display = 'block';
                        }
                        
                        if (personalNote) {
                            personalNote.innerHTML = '<strong>üß† Personal pattern:</strong> Based on your preferences, this is a great match.';
                            personalNote.style.display = 'block';
                        }
                        
                        if (weatherNote) {
                            weatherNote.innerHTML = '<strong>üéØ Why this works:</strong> Perfect for your current mood and the time of day!';
                            weatherNote.style.display = 'block';
                        }
                    }
                    
                    console.log('‚úÖ Insights displayed successfully');
                } else {
                    console.log('üôà Hiding insights...');
                    insightsContent.classList.add('hidden');
                    newToggle.textContent = 'ü§ñ Why this choice? ‚Üì';
                }
            });
            
            console.log('‚úÖ Improved insights toggle ready');
        } else {
            console.log('‚ùå Insights toggle button not found');
        }
    }, 5000);
    </script>
</body>
</html>